<%- include('partials/header', { title: title }) %>

<div class="container my-4">
  <h2 class="fw-bold text-primary mb-4">Th√¥ng tin h·ªçc vi√™n üë§</h2>

  

  <!-- üßæ Th√¥ng tin k·∫ø ho·∫°ch 
   <h6 class="text-primary fw-bold">üìò K·∫ø ho·∫°ch h·ªçc chi ti·∫øt:</h6>
    <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;"><%= plan.plan %></pre>-->
  <div class="card shadow-sm p-4">
    <h5><strong>üë§ H·ªçc vi√™n:</strong> <%= plan.student_name %></h5>
    <p><strong>ID k·∫ø ho·∫°ch:</strong> <%= plan.id %></p>
    <p><strong>Tr√¨nh ƒë·ªô:</strong> <%= plan.level %></p>
    <p><strong>M·ª•c ti√™u h·ªçc t·∫≠p:</strong> <%= plan.goals || '‚Äî' %></p>
    <p><strong>K·ªπ nƒÉng y·∫øu:</strong> <%= plan.weak_points || '‚Äî' %></p>
    <p><strong>Th·ªùi gian h·ªçc m·ªói ng√†y:</strong> <%= plan.available_time || '‚Äî' %></p>
    <p><strong>Ng√†y t·∫°o:</strong> 
      <%= new Date(plan.created_at).toLocaleTimeString('vi-VN') %> 
      <%= new Date(plan.created_at).toLocaleDateString('vi-VN') %>
    </p>

  </div>

  <!-- üß© Form nh·∫≠p d·ªØ li·ªáu ƒëi·ªÉm s·ªë -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-info text-white fw-bold">
      üìä Ph√¢n t√≠ch nƒÉng l·ª±c h·ªçc vi√™n t·ª´ d·ªØ li·ªáu ƒëi·ªÉm s·ªë
    </div>
    <div class="card-body">
      <form id="analysisForm" onsubmit="analyze(event)">
          <input type="hidden" id="plan_id" value="<%= plan.id %>">

        <div class="row mb-3">
          <div class="col-md-4">
            <label>Ng·ªØ ph√°p</label>
            <input type="number" class="form-control" id="grammar" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>T·ª´ v·ª±ng</label>
            <input type="number" class="form-control" id="vocab" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Nghe hi·ªÉu</label>
            <input type="number" class="form-control" id="listening" placeholder="0 - 100" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>N√≥i</label>
            <input type="number" class="form-control" id="speaking" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>ƒê·ªçc hi·ªÉu</label>
            <input type="number" class="form-control" id="reading" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Th·ªùi gian h·ªçc m·ªói ng√†y (gi·ªù)</label>
            <input type="number" class="form-control" id="studyTime" placeholder="1 - 5" required>
          </div>
        </div>

        <div class="mb-3">
          <label>K·ªπ nƒÉng y·∫øu (n·∫øu c√≥)</label>
          <input type="text" class="form-control" id="weakSkill" placeholder="V√≠ d·ª•: nghe hi·ªÉu">
        </div>

        <button type="submit" class="btn btn-primary">Ph√¢n t√≠ch nƒÉng l·ª±c</button>
      </form>
<div id="loadingSpinner" class="text-center mt-3" style="display:none;">
  <div class="spinner-border text-primary" role="status"></div>
  <p class="mt-2 text-muted">ƒêang ph√¢n t√≠ch vui l√≤ng ch·ªù...</p>
</div>

      <!-- Hi·ªÉn th·ªã k·∫øt qu·∫£ -->
      <div id="analysisSection" style="display:none;">
        <div id="analysisResult" class="mt-3"></div>
      </div>
    </div>
  </div>

  <a href="/learning-plan/history-view" class="btn btn-secondary mt-3">‚Üê Quay l·∫°i</a>
</div>

<script>
  // ‚úÖ X·ª≠ l√Ω chuy·ªÉn trang theo ID nh·∫≠p
  function viewPlan(event) {
    event.preventDefault();
    const id = document.getElementById("planIdInput").value.trim();
    if (id) window.location.href = `/learning-plan/analysis/${id}`;
    else alert("Vui l√≤ng nh·∫≠p ID k·∫ø ho·∫°ch!");
  }

  // ‚úÖ H√†m g·ª≠i d·ªØ li·ªáu v√† hi·ªÉn th·ªã k·∫øt qu·∫£ ph√¢n t√≠ch nƒÉng l·ª±c
  async function analyze(event) {
  event.preventDefault();

  // L·∫•y d·ªØ li·ªáu t·ª´ form
  const plan_id = document.getElementById("plan_id").value;
  const grammar = document.getElementById("grammar").value;
  const vocab = document.getElementById("vocab").value;
  const listening = document.getElementById("listening").value;
  const speaking = document.getElementById("speaking").value;
  const reading = document.getElementById("reading").value;
  const studyTime = document.getElementById("studyTime").value;
  const weakSkill = document.getElementById("weakSkill").value;

  const payload = {
    plan_id,
    grammar,
    vocab,
    listening,
    speaking,
    reading,
    studyTime,
    weakSkill
  };

  console.log("üì§ G·ª≠i d·ªØ li·ªáu ph√¢n t√≠ch:", payload);

  // Hi·ªán hi·ªáu ·ª©ng ch·ªù
  const loadingSpinner = document.getElementById("loadingSpinner");
  const analysisSection = document.getElementById("analysisSection");
  const analysisResult = document.getElementById("analysisResult");

  loadingSpinner.style.display = "block";
  analysisSection.style.display = "none";

  try {
    const res = await fetch("/learning-plan/analyze-progress", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    console.log("üìä K·∫øt qu·∫£ AI:", result);

    // ·∫®n hi·ªáu ·ª©ng ch·ªù v√† hi·ªán k·∫øt qu·∫£
    loadingSpinner.style.display = "none";
    analysisSection.style.display = "block";

    if (result.success) {
      analysisResult.innerHTML = `
        <div class="alert alert-success fw-bold">‚úÖ Ph√¢n t√≠ch ho√†n t·∫•t!</div>
        <pre class="p-3 bg-light rounded border">${result.analysis}</pre>
      `;
    } else {
      analysisResult.innerHTML = `
        <div class="alert alert-danger">${result.message}</div>
      `;
    }

  } catch (err) {
    console.error("‚ùå L·ªói khi ph√¢n t√≠ch nƒÉng l·ª±c:", err);
    loadingSpinner.style.display = "none";
    alert("L·ªói khi ph√¢n t√≠ch: " + err.message);
  }
}
</script>

<%- include('partials/footer') %>
