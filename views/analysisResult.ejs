<%- include('partials/header', { title: title }) %>

<div class="container my-4">
  <h2 class="fw-bold text-primary mb-4">ThÃ´ng tin há»c viÃªn ğŸ‘¤</h2>

  

  <!-- ğŸ§¾ ThÃ´ng tin káº¿ hoáº¡ch 
   <h6 class="text-primary fw-bold">ğŸ“˜ Káº¿ hoáº¡ch há»c chi tiáº¿t:</h6>
    <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;"><%= plan.plan %></pre>-->
  <div class="card shadow-sm p-4">
    <h5><strong>ğŸ‘¤ Há»c viÃªn:</strong> <%= plan.student_name %></h5>
    <p><strong>ID káº¿ hoáº¡ch:</strong> <%= plan.id %></p>
    <p><strong>TrÃ¬nh Ä‘á»™:</strong> <%= plan.level %></p>
    <p><strong>Má»¥c tiÃªu há»c táº­p:</strong> <%= plan.goals || 'â€”' %></p>
    <p><strong>Ká»¹ nÄƒng yáº¿u:</strong> <%= plan.weak_points || 'â€”' %></p>
    <p><strong>Thá»i gian há»c má»—i ngÃ y:</strong> <%= plan.available_time || 'â€”' %></p>
    <p><strong>NgÃ y táº¡o:</strong> 
      <%= new Date(plan.created_at).toLocaleTimeString('vi-VN') %> 
      <%= new Date(plan.created_at).toLocaleDateString('vi-VN') %>
    </p>

  </div>

  <!-- ğŸ§© Form nháº­p dá»¯ liá»‡u Ä‘iá»ƒm sá»‘ -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-info text-white fw-bold">
      ğŸ“Š PhÃ¢n tÃ­ch nÄƒng lá»±c há»c viÃªn tá»« dá»¯ liá»‡u Ä‘iá»ƒm sá»‘
    </div>
    <div class="card-body">
      <form id="analysisForm" onsubmit="analyze(event)">
          <input type="hidden" id="plan_id" value="<%= plan.id %>">

        <div class="row mb-3">
          <div class="col-md-4">
            <label>Ngá»¯ phÃ¡p</label>
            <input type="number" class="form-control" id="grammar" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Tá»« vá»±ng</label>
            <input type="number" class="form-control" id="vocab" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Nghe hiá»ƒu</label>
            <input type="number" class="form-control" id="listening" placeholder="0 - 100" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>NÃ³i</label>
            <input type="number" class="form-control" id="speaking" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Äá»c hiá»ƒu</label>
            <input type="number" class="form-control" id="reading" placeholder="0 - 100" required>
          </div>
          <div class="col-md-4">
            <label>Thá»i gian há»c má»—i ngÃ y (giá»)</label>
            <input type="number" class="form-control" id="studyTime" placeholder="1 - 5" required>
          </div>
        </div>

        <div class="mb-3">
          <label>Ká»¹ nÄƒng yáº¿u (náº¿u cÃ³)</label>
          <input type="text" class="form-control" id="weakSkill" placeholder="VÃ­ dá»¥: nghe hiá»ƒu">
        </div>

        <button type="submit" class="btn btn-primary">PhÃ¢n tÃ­ch nÄƒng lá»±c</button>
      </form>
<div id="loadingSpinner" class="text-center mt-3" style="display:none;">
  <div class="spinner-border text-primary" role="status"></div>
  <p class="mt-2 text-muted">Äang phÃ¢n tÃ­ch vui lÃ²ng chá»...</p>
</div>

      <!-- Hiá»ƒn thá»‹ káº¿t quáº£ -->
      <div id="analysisSection" style="display:none;">
        <div id="analysisResult" class="mt-3"></div>
      </div>
    </div>
  </div>

  <a href="/learning-plan/history-view" class="btn btn-secondary mt-3">â† Quay láº¡i</a>
</div>

<script>
  // âœ… Xá»­ lÃ½ chuyá»ƒn trang theo ID nháº­p
  function viewPlan(event) {
    event.preventDefault();
    const id = document.getElementById("planIdInput").value.trim();
    if (id) window.location.href = `/learning-plan/analysis/${id}`;
    else alert("Vui lÃ²ng nháº­p ID káº¿ hoáº¡ch!");
  }

  // âœ… HÃ m gá»­i dá»¯ liá»‡u vÃ  hiá»ƒn thá»‹ káº¿t quáº£ phÃ¢n tÃ­ch nÄƒng lá»±c
  async function analyze(event) {
  event.preventDefault();

  // Láº¥y dá»¯ liá»‡u tá»« form
  const plan_id = document.getElementById("plan_id").value;
  const grammar = document.getElementById("grammar").value;
  const vocab = document.getElementById("vocab").value;
  const listening = document.getElementById("listening").value;
  const speaking = document.getElementById("speaking").value;
  const reading = document.getElementById("reading").value;
  const studyTime = document.getElementById("studyTime").value;
  const weakSkill = document.getElementById("weakSkill").value;

  const payload = {
    plan_id,
    grammar,
    vocab,
    listening,
    speaking,
    reading,
    studyTime,
    weakSkill
  };

  console.log("ğŸ“¤ Gá»­i dá»¯ liá»‡u phÃ¢n tÃ­ch:", payload);

  // Hiá»‡n hiá»‡u á»©ng chá»
  const loadingSpinner = document.getElementById("loadingSpinner");
  const analysisSection = document.getElementById("analysisSection");
  const analysisResult = document.getElementById("analysisResult");

  loadingSpinner.style.display = "block";
  analysisSection.style.display = "none";

  try {
    const res = await fetch("/learning-plan/analyze-progress", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    console.log("ğŸ“Š Káº¿t quáº£ AI:", result);

   // áº¨n hiá»‡u á»©ng chá» vÃ  hiá»‡n káº¿t quáº£
loadingSpinner.style.display = "none";
analysisSection.style.display = "block";

if (result.success) {
  const converter = new showdown.Converter();
  const htmlContent = converter.makeHtml(result.analysis);

  // âœ… render ná»™i dung phÃ¢n tÃ­ch + canvas
  analysisResult.innerHTML = `
    <div class="alert alert-success fw-bold mb-3">âœ… PhÃ¢n tÃ­ch hoÃ n táº¥t!</div>

    <div id="analysisText" class="p-4 bg-white rounded shadow-sm border" 
         style="line-height: 1.7; font-size: 1rem;">
      ${htmlContent}
    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="copyResult" class="btn btn-outline-secondary">ğŸ“‹ Sao chÃ©p ná»™i dung</button>
      <button id="downloadText" class="btn btn-outline-primary">ğŸ“„ Táº£i ná»™i dung (TXT)</button>
    </div>

    <h5 class="mt-4 fw-bold text-primary">ğŸ“Š Biá»ƒu Ä‘á»“ tiáº¿n Ä‘á»™ há»c</h5>
    <canvas id="progressChart" width="600" height="250" style="max-width:100%;"></canvas>
    <div class="mt-2">
      <button id="downloadChart" class="btn btn-success">ğŸ“¸ Táº£i biá»ƒu Ä‘á»“ (PNG)</button>
    </div>
  `;
  if (result.success) {
  const converter = new showdown.Converter();
  const htmlContent = converter.makeHtml(result.analysis);

  // âœ… render ná»™i dung phÃ¢n tÃ­ch + canvas
  analysisResult.innerHTML = `
    <div class="alert alert-success fw-bold mb-3">âœ… PhÃ¢n tÃ­ch hoÃ n táº¥t!</div>

    <div id="analysisText" class="p-4 bg-white rounded shadow-sm border" 
         style="line-height: 1.7; font-size: 1rem;">
      ${htmlContent}
    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="copyResult" class="btn btn-outline-secondary">ğŸ“‹ Sao chÃ©p ná»™i dung</button>
      <button id="downloadText" class="btn btn-outline-primary">ğŸ“„ Táº£i ná»™i dung (TXT)</button>
    </div>

    <h5 class="mt-4 fw-bold text-primary">ğŸ“Š Biá»ƒu Ä‘á»“ tiáº¿n Ä‘á»™ há»c</h5>
    <canvas id="progressChart" width="600" height="250" style="max-width:100%;"></canvas>
    <div class="mt-2">
      <button id="downloadChart" class="btn btn-success">ğŸ“¸ Táº£i biá»ƒu Ä‘á»“ (PNG)</button>
    </div>
  `;

  // ğŸ§© --- chuáº©n bá»‹ dá»¯ liá»‡u cho biá»ƒu Ä‘á»“ ---
  let labels = ['Ngá»¯ phÃ¡p', 'Tá»« vá»±ng', 'Nghe', 'NÃ³i', 'Äá»c'];
  let data = [
    Number(grammar),
    Number(vocab),
    Number(listening),
    Number(speaking),
    Number(reading)
  ];

  // --- táº¡o chart báº±ng Chart.js ---
  const ctx = document.getElementById('progressChart').getContext('2d');

  if (window._progressChartInstance) {
    window._progressChartInstance.destroy();
  }

  window._progressChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Äiá»ƒm (%)',
        data,
        backgroundColor: [
          '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, max: 100 }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // --- NÃºt táº£i biá»ƒu Ä‘á»“ ---
  document.getElementById('downloadChart').addEventListener('click', () => {
    const url = window._progressChartInstance.toBase64Image();
    const link = document.createElement('a');
    link.href = url;
    link.download = `bieu-do-${Date.now()}.png`;
    link.click();
  });

  // --- NÃºt sao chÃ©p vÃ  táº£i txt ---
  document.getElementById('copyResult').addEventListener('click', async () => {
    const text = document.getElementById('analysisText').innerText;
    await navigator.clipboard.writeText(text);
    alert('âœ… ÄÃ£ sao chÃ©p ná»™i dung phÃ¢n tÃ­ch!');
  });

  document.getElementById('downloadText').addEventListener('click', () => {
    const text = document.getElementById('analysisText').innerText;
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `phan-tich-${Date.now()}.txt`;
    link.click();
    link.remove();
  });
}

// canvas Ä‘á»ƒ táº£i biá»ƒu Ä‘á»“
  // --- sau khi innerHTML Ä‘áº·t xong, khá»Ÿi táº¡o cÃ¡c handlers & chart (Ä‘oáº¡n tiáº¿p theo) ---
}


  } catch (err) {
    console.error("âŒ Lá»—i khi phÃ¢n tÃ­ch nÄƒng lá»±c:", err);
    loadingSpinner.style.display = "none";
    alert("Lá»—i khi phÃ¢n tÃ­ch: " + err.message);
  }
}
  
  
  
</script>

<%- include('partials/footer') %>
