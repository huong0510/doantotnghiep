<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI D·∫°y H·ªôi Tho·∫°i</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
/* --- V√πng chat --- */
.chat-box {
  height: 60vh;
  overflow-y: auto;
  background: #fff;
  padding: 20px;
  border-radius: 20px;
  border: none;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

/* --- Tin nh·∫Øn --- */
.msg.user { text-align: right; }
.msg.assistant { text-align: left; }

.bubble {
  display: inline-block;
  padding: 12px 16px;
  border-radius: 18px;
  margin: 8px 0;
  max-width: 80%;
  line-height: 1.5;
  word-wrap: break-word;
  animation: fadeIn 0.4s ease;
}

.bubble.user {
  background: #e53935;
  color: #fff;
  border-bottom-right-radius: 6px;
  box-shadow: 0 2px 6px rgba(229, 57, 53, 0.2);
}

.bubble.assistant {
  background: #f8f9fa;
  color: #222;
  border-bottom-left-radius: 6px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- N√∫t t√¨nh hu·ªëng --- */
#scenario-buttons {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

.scenario-btn {
  cursor: pointer;
  border-radius: 30px;
  font-weight: 600;
  transition: all 0.25s ease;
  border: 1px solid #e0e0e0;
  background: #fff;
  color: #333;
  padding: 10px 20px;
}

.scenario-btn:hover {
  background: #fff5f5;
  color: #e53935;
  border-color: #e53935;
}

.scenario-btn.active {
  background: #e53935 !important;
  color: #fff !important;
  border: none !important;
  box-shadow: 0 0 8px rgba(229, 57, 53, 0.3);
}

/* --- √î nh·∫≠p --- */
#convInput {
  border-radius: 30px;
  padding: 12px 20px;
  border: 1px solid #ddd;
  transition: all 0.2s ease;
}
#convInput:focus {
  outline: none;
  border-color: #e53935;
  box-shadow: 0 0 6px rgba(229, 57, 53, 0.3);
}

/* --- N√∫t g·ª≠i --- */
#sendBtn {
  background-color: #e53935;
  border: none;
  color: #fff;
  border-radius: 30px;
  padding: 10px 24px;
  font-weight: 600;
  transition: all 0.2s ease;
}
#sendBtn:hover {
  background-color: #c62828;
  transform: scale(1.05);
}

/* --- Mic --- */
#micBtn {
  border: 2px solid #e53935;
  color: #e53935;
  background: #fff;
  border-radius: 30px;
  padding: 8px 18px;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.25s ease;
}
#micBtn:hover {
  background: #fff5f5;
  transform: scale(1.05);
}
#micBtn.listening {
  background: #e53935;
  color: #fff;
}

/* --- X√≥a --- */
#clearBtn {
  border-radius: 30px;
  border: 1px solid #ccc;
  background: #fff;
  color: #333;
  padding: 10px 24px;
  transition: all 0.2s ease;
}
#clearBtn:hover {
  background: #fff5f5;
  border-color: #e53935;
  color: #e53935;
}
/* üí¨ Hi·ªáu ·ª©ng chat m∆∞·ª£t */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.bubble {
  animation: slideUp 0.4s ease-out;
}
.msg.ai {
  animation: popIn 0.3s ease;
}

@keyframes popIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
  </style>
</head>

<body class="p-4 bg-light">
  <div class="container text-center">
    <div class="col-md-8 offset-md-2">
      <h3 class="fw-bold mb-3 text-danger">üéì AI D·∫°y H·ªôi Tho·∫°i ‚Äî Roleplay</h3>
      <p class="text-muted">Ch·ªçn t√¨nh hu·ªëng, nh·∫≠p c√¢u b·∫°n mu·ªën n√≥i v√† th·ª±c h√†nh. AI s·∫Ω tr·∫£ l·ªùi b·∫±ng ti·∫øng Nh·∫≠t + d·ªãch + ch·ªânh s·ª≠a ng·∫Øn.</p>

      <!-- üî• N√∫t t√¨nh hu·ªëng -->
      <div id="scenario-buttons"></div>
      <small class="text-muted d-block mb-3" id="currentScenarioLabel">T√¨nh hu·ªëng: ...</small>

      <!-- Chat box -->
      <div class="chat-box mb-3" id="convBox"></div>

      <!-- Form nh·∫≠p -->
      <form id="convForm" class="d-flex justify-content-center align-items-center gap-2">
        <input type="text" id="convInput" class="form-control" placeholder="Nh·∫≠p ho·∫∑c n√≥i c√¢u mu·ªën luy·ªán (VD: „Åì„Çì„Å´„Å°„ÅØ)" autocomplete="off">
        <button type="submit" id="sendBtn">G·ª≠i</button>
        <button type="button" id="micBtn">üé§</button>
        <button type="button" id="clearBtn">X√≥a</button>
      </form>

      <div class="mt-3 text-muted small">
        üí° G·ª£i √Ω: B·∫°n c√≥ th·ªÉ vi·∫øt b·∫±ng ti·∫øng Vi·ªát/romaji/t·ª´ v·ª±ng, AI s·∫Ω ph·∫£n h·ªìi b·∫±ng ti·∫øng Nh·∫≠t v√† d·ªãch.
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  let currentScenario = 'greeting';

  async function loadScenarios() {
    try {
      const res = await fetch('/api/conversation/scenarios');
      const data = await res.json();
      if (!data.success) return;

      const container = document.getElementById('scenario-buttons');
      container.innerHTML = '';

      data.scenarios.forEach(sc => {
        const btn = document.createElement('button');
        btn.className = 'scenario-btn';
        btn.innerText = sc.title;
        btn.dataset.scenario = sc.key;
        if (sc.key === currentScenario) btn.classList.add('active');

        btn.addEventListener('click', () => {
          document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentScenario = sc.key;
          document.getElementById('currentScenarioLabel').textContent = 'T√¨nh hu·ªëng: ' + sc.title;

          fetch('/api/conversation/clear', { method: 'POST' });
          document.getElementById('convBox').innerHTML = '';
        });

        container.appendChild(btn);
      });

      document.getElementById('currentScenarioLabel').textContent =
        'T√¨nh hu·ªëng: ' + (data.scenarios.find(s => s.key === currentScenario)?.title || '');
    } catch (e) {
      console.error('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch t√¨nh hu·ªëng:', e);
    }
  }

function speakJapanese(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel(); // üîß fix ƒë·ªçc 2 l·∫ßn
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    speechSynthesis.speak(utterance);
  } else {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc gi·ªçng n√≥i.");
  }
}

const convBox = $('#convBox');

function appendMessage(role, text) {
  const c = $('<div>').addClass('msg ' + (role === 'user' ? 'user' : 'assistant'));
  const bubble = $('<div>').addClass('bubble ' + (role === 'user' ? 'user' : 'assistant'));

  if (role === 'assistant') {
    const lines = text.split('\n');
    const jpText = lines[0];
    const otherText = lines.slice(1).join('<br>');
    bubble.html(`
      <span>${jpText}</span>
      <button class="btn btn-sm btn-link p-0 ms-2 play-audio" data-text="${jpText}">üîä</button>

      ${otherText ? "<div style='margin-top:4px; font-size:0.9em; color:#555'>" + otherText + "</div>" : ""}
    `);
  } else {
    bubble.html(text.replace(/\n/g,'<br>'));
  }

  c.append(bubble);
  convBox.append(c);
  convBox.scrollTop(convBox[0].scrollHeight);
}

$(document).on('click', '.play-audio', function() {
  const txt = $(this).data('text');
  speakJapanese(txt);
});

$('#convForm').on('submit', async function(e) {
  e.preventDefault();
  const txt = $('#convInput').val().trim();
  if (!txt) return;

  // üîä Ph√°t √¢m ‚Äúting~‚Äù khi g·ª≠i tin nh·∫Øn
  const sendSound = document.getElementById('sendSound');
  if (sendSound) {
    sendSound.currentTime = 0;
    sendSound.play().catch(() => {});
  }
  appendMessage('user', txt);
  $('#convInput').val('');

      try {
        const res = await fetch('/api/conversation', {
           method: 'POST',
            headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ scenario: currentScenario, message: txt }) });
              const data = await res.json(); 
           
              if (data.success && data.reply) { appendMessage('assistant', data.reply); } else if (data.error) { appendMessage('assistant', '<span style="color:crimson">L·ªói: ' + data.error + '</span>'); } else { appendMessage('assistant', '<span style="color:crimson">Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi</span>'); } } catch (err) { convBox.children().last().remove(); appendMessage('assistant', '<span style="color:crimson">L·ªói k·∫øt n·ªëi: ' + err.message + '</span>'); } });

$('#clearBtn').click(function() {
  $('#convBox').empty();
});
// üéôÔ∏è Nh·∫≠n gi·ªçng n√≥i ti·∫øng Nh·∫≠t (Speech-to-Text)
let recognizing = false;
let recognition;

if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ja-JP';//'vi-VN' n·∫øu mu·ªën n√≥i ti·∫øng vi·ªát
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    recognizing = true;
    $('#micBtn').text('üõë D·ª´ng').removeClass('btn-outline-danger').addClass('btn-danger');
  };

  recognition.onend = () => {
    recognizing = false;
    $('#micBtn').text('üé§ ').removeClass('btn-danger').addClass('btn-outline-danger');
  };
recognition.onresult = (event) => {
  const spokenText = event.results[0][0].transcript.trim();
  $('#convInput').val(spokenText);

  // üîç L·∫•y n·ªôi dung ph·∫£n h·ªìi AI m·ªõi nh·∫•t
  const lastAssistantBubble = $('#convBox .msg.assistant .bubble').last().html() || "";
  let jpSample = "";

  // 1Ô∏è‚É£ ∆Øu ti√™n t√¨m c√¢u trong ngo·∫∑c „Äå„Äç (chu·∫©n ti·∫øng Nh·∫≠t)
  const bracketMatch = lastAssistantBubble.match(/„Äå([^„Äç]+)„Äç/);
  if (bracketMatch) {
    jpSample = bracketMatch[1].trim();
  } else {
    // 2Ô∏è‚É£ N·∫øu kh√¥ng c√≥ „Äå„Äç, th·ª≠ t√¨m c√°c m·∫´u kh√°c c√≥ romaji
    const romanjiHintMatch = lastAssistantBubble.match(/([„ÅÅ-„Çì„Ç°-„É≥‰∏Ä-ÈæØ„Éº„Éª]+)[^<]*\([A-Za-z\s]+\)/);
    if (romanjiHintMatch) {
      jpSample = romanjiHintMatch[1].trim();
    } else {
      // 3Ô∏è‚É£ N·∫øu v·∫´n kh√¥ng c√≥, l·∫•y d√≤ng ti·∫øng Nh·∫≠t d√†i nh·∫•t trong c√¢u tr·∫£ l·ªùi
      const japaneseMatches = lastAssistantBubble.match(/[„ÅÅ-„Çì„Ç°-„É≥‰∏Ä-ÈæØ„Éº„Éª„Äå„Äç]+/g);
      if (japaneseMatches && japaneseMatches.length > 0) {
        jpSample = japaneseMatches.reduce((a, b) => (b.length > a.length ? b : a), "");
      }
    }
  }

  // N·∫øu v·∫´n kh√¥ng t√¨m ƒë∆∞·ª£c c√¢u m·∫´u
  if (!jpSample) {
    appendMessage('assistant', `<small>‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c√¢u m·∫´u ƒë·ªÉ ch·∫•m ƒëi·ªÉm.</small>`);
    return;
  }

  // üßÆ T√≠nh ƒëi·ªÉm ph√°t √¢m
  const score = stringSimilarity(spokenText, jpSample);
  let color = score > 85 ? 'green' : score > 60 ? 'orange' : 'red';

  appendMessage(
    'assistant',
    `üéØ <b>ƒêi·ªÉm ph√°t √¢m:</b> <span style="color:${color}">${score}%</span><br>
     <small>üó£Ô∏è C√¢u m·∫´u: ${jpSample}<br>
     üì¢ B·∫°n n√≥i: ${spokenText}</small>`
  );

  // ‚è© G·ª≠i c√¢u v·ª´a n√≥i cho AI ti·∫øp t·ª•c ph·∫£n h·ªìi
  $('#convForm').submit();
};




  recognition.onerror = (event) => {
    console.error('L·ªói nh·∫≠n gi·ªçng n√≥i:', event.error);
    alert('L·ªói nh·∫≠n gi·ªçng n√≥i: ' + event.error);
  };
} else {
  alert('‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n gi·ªçng n√≥i (h√£y d√πng Chrome).');
}
// üìè H√†m t√≠nh ƒë·ªô gi·ªëng gi·ªØa hai c√¢u (Levenshtein)
function stringSimilarity(s1, s2) {
  s1 = s1.toLowerCase().trim();
  s2 = s2.toLowerCase().trim();

  const len1 = s1.length;
  const len2 = s2.length;
  const dp = Array(len1 + 1)
    .fill(null)
    .map(() => Array(len2 + 1).fill(0));

  for (let i = 0; i <= len1; i++) dp[i][0] = i;
  for (let j = 0; j <= len2; j++) dp[0][j] = j;

  for (let i = 1; i <= len1; i++) {
    for (let j = 1; j <= len2; j++) {
      const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1, // x√≥a
        dp[i][j - 1] + 1, // th√™m
        dp[i - 1][j - 1] + cost // thay th·∫ø
      );
    }
  }

  const distance = dp[len1][len2];
  const maxLen = Math.max(len1, len2);
  return ((1 - distance / maxLen) * 100).toFixed(1); // ph·∫ßn trƒÉm gi·ªëng
}

$('#micBtn').click(function() {
  if (recognizing) {
    recognition.stop();
    return;
  }
  recognition.start();
});


// Khi ng∆∞·ªùi d√πng nh·∫•n "G·ª≠i"
sendBtn.addEventListener("click", async () => {
  const msg = inputMsg.value.trim();
  if (!msg) return;

  // üîä Ph√°t √¢m "ting~" khi g·ª≠i
  sendSound.currentTime = 0;
  sendSound.play();

  // G·ª≠i tin nh·∫Øn l√™n server
  const res = await fetch("/chat/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: msg })
  });

  const data = await res.json();
  
  // Hi·ªÉn th·ªã ph·∫£n h·ªìi
  showMessage("ai", data.reply);

  // üîä Ph√°t √¢m "pling~" khi AI tr·∫£ l·ªùi
  replySound.currentTime = 0;
  replySound.play();

  inputMsg.value = "";
});

function showMessage(sender, text) {
  const chatBox = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = sender === "ai" ? "msg ai" : "msg user";
  div.textContent = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}
loadScenarios();
</script>
<!-- √Çm thanh g·ª≠i & ph·∫£n h·ªìi -->
<audio id="sendSound" src="/sounds/bubble-254777.mp3"></audio>
<audio id="replySound" src="/sounds/bubble-pop-06-351337.mp3"></audio>

</body>
</html>
