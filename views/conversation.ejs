<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Dáº¡y Há»™i Thoáº¡i</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-box { height: 60vh; overflow-y: auto; background:#fbfbfe; padding:12px; border-radius:8px; border:1px solid #eee; }
    .msg.user { text-align: right; }
    .msg.assistant { text-align: left; }
    .bubble { display:inline-block; padding:10px 12px; border-radius:14px; margin:6px 0; max-width:82%; }
    .bubble.user { background:#0084ff; color:white; border-bottom-right-radius:4px; }
    .bubble.assistant { background:#f1f1f1; color:#111; border-bottom-left-radius:4px; }
    .scenario-btn { cursor:pointer; }
  </style>
</head>
<body class="p-4">

<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <h3>AI Dáº¡y Há»™i Thoáº¡i â€” Roleplay</h3>
      <p>Chá»n tÃ¬nh huá»‘ng, nháº­p cÃ¢u báº¡n muá»‘n nÃ³i vÃ  thá»±c hÃ nh. AI sáº½ tráº£ lá»i báº±ng tiáº¿ng Nháº­t + dá»‹ch + chá»‰nh sá»­a ngáº¯n.</p>

      <!-- ğŸ”¥ Táº¡o nÃºt Ä‘á»™ng -->
      <div id="scenario-buttons" class="btn-group" role="group"></div>
      <small class="text-muted ms-2" id="currentScenarioLabel">TÃ¬nh huá»‘ng: ...</small>

      <div class="chat-box" id="convBox"></div>

<form id="convForm" class="d-flex mt-3">
  <input type="hidden" id="userId" value="<%= user ? user.id : '' %>">
  <input type="text" id="convInput" class="form-control me-2" placeholder="Nháº­p hoáº·c nÃ³i cÃ¢u muá»‘n luyá»‡n (VD: ã“ã‚“ã«ã¡ã¯ã€ç§ã¯å­¦ç”Ÿã§ã™)" autocomplete="off">
  <button class="btn btn-primary" id="sendBtn">Gá»­i</button>
  <button type="button" class="btn btn-outline-danger ms-2" id="micBtn">ğŸ¤</button>
  <button type="button" class="btn btn-secondary ms-2" id="clearBtn">XÃ³a</button>
</form>



      <div class="mt-3 text-muted">
        <small>Gá»£i Ã½: Báº¡n cÃ³ thá»ƒ viáº¿t báº±ng tiáº¿ng Viá»‡t/romaji/tá»« vá»±ng, AI sáº½ pháº£n há»“i báº±ng tiáº¿ng Nháº­t vÃ  dá»‹ch.</small>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let currentScenario = 'greeting';

async function loadScenarios() {
  try {
    const res = await fetch('/api/conversation/scenarios');
    const data = await res.json();
    if (!data.success) return;

    const container = document.getElementById('scenario-buttons');
    container.innerHTML = '';

    data.scenarios.forEach(sc => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-primary';
      btn.innerText = sc.title;
      btn.dataset.scenario = sc.key;
      if (sc.key === currentScenario) btn.classList.add('active');

      btn.addEventListener('click', () => {
        document.querySelectorAll('#scenario-buttons button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentScenario = sc.key;
        document.getElementById('currentScenarioLabel').textContent = 'TÃ¬nh huá»‘ng: ' + sc.title;

        // XÃ³a há»™i thoáº¡i khi Ä‘á»•i tÃ¬nh huá»‘ng
        fetch('/api/conversation/clear', { method: 'POST' });
        document.getElementById('convBox').innerHTML = '';
      });

      container.appendChild(btn);
    });

    document.getElementById('currentScenarioLabel').textContent =
      'TÃ¬nh huá»‘ng: ' + (data.scenarios.find(s => s.key === currentScenario)?.title || '');
  } catch (e) {
    console.error('KhÃ´ng táº£i Ä‘Æ°á»£c danh sÃ¡ch tÃ¬nh huá»‘ng:', e);
  }
}

function speakJapanese(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel(); // ğŸ”§ fix Ä‘á»c 2 láº§n
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    speechSynthesis.speak(utterance);
  } else {
    alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»c giá»ng nÃ³i.");
  }
}

const convBox = $('#convBox');

function appendMessage(role, text) {
  const c = $('<div>').addClass('msg ' + (role === 'user' ? 'user' : 'assistant'));
  const bubble = $('<div>').addClass('bubble ' + (role === 'user' ? 'user' : 'assistant'));

  if (role === 'assistant') {
    const lines = text.split('\n');
    const jpText = lines[0];
    const otherText = lines.slice(1).join('<br>');
    bubble.html(`
      <span>${jpText}</span>
      <button class="btn btn-sm btn-link p-0 ms-2 play-audio" data-text="${jpText}">ğŸ”Š</button>

      ${otherText ? "<div style='margin-top:4px; font-size:0.9em; color:#555'>" + otherText + "</div>" : ""}
    `);
  } else {
    bubble.html(text.replace(/\n/g,'<br>'));
  }

  c.append(bubble);
  convBox.append(c);
  convBox.scrollTop(convBox[0].scrollHeight);
}

$(document).on('click', '.play-audio', function() {
  const txt = $(this).data('text');
  speakJapanese(txt);
});

$('#convForm').on('submit', async function(e)
 { e.preventDefault();
   const txt = $('#convInput').val().trim();
    if (!txt) return; appendMessage('user', txt);
     $('#convInput').val(''); appendMessage('assistant', '<em>Äang suy nghÄ©...</em>');
      try {
        const res = await fetch('/api/conversation', {
           method: 'POST',
            headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ scenario: currentScenario, message: txt }) });
              const data = await res.json(); 
              convBox.children().last().remove();
              if (data.success && data.reply) { appendMessage('assistant', data.reply); } else if (data.error) { appendMessage('assistant', '<span style="color:crimson">Lá»—i: ' + data.error + '</span>'); } else { appendMessage('assistant', '<span style="color:crimson">KhÃ´ng nháº­n Ä‘Æ°á»£c pháº£n há»“i</span>'); } } catch (err) { convBox.children().last().remove(); appendMessage('assistant', '<span style="color:crimson">Lá»—i káº¿t ná»‘i: ' + err.message + '</span>'); } });

$('#clearBtn').click(function() {
  $('#convBox').empty();
});
// ğŸ™ï¸ Nháº­n giá»ng nÃ³i tiáº¿ng Nháº­t (Speech-to-Text)
let recognizing = false;
let recognition;

if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ja-JP';//'vi-VN' náº¿u muá»‘n nÃ³i tiáº¿ng viá»‡t
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    recognizing = true;
    $('#micBtn').text('ğŸ›‘ Dá»«ng').removeClass('btn-outline-danger').addClass('btn-danger');
  };

  recognition.onend = () => {
    recognizing = false;
    $('#micBtn').text('ğŸ¤ NÃ³i').removeClass('btn-danger').addClass('btn-outline-danger');
  };
recognition.onresult = (event) => {
  const spokenText = event.results[0][0].transcript.trim();
  $('#convInput').val(spokenText);

  // ğŸ” Láº¥y ná»™i dung pháº£n há»“i AI má»›i nháº¥t
  const lastAssistantBubble = $('#convBox .msg.assistant .bubble').last().html() || "";
  let jpSample = "";

  // 1ï¸âƒ£ Æ¯u tiÃªn tÃ¬m cÃ¢u trong ngoáº·c ã€Œã€ (chuáº©n tiáº¿ng Nháº­t)
  const bracketMatch = lastAssistantBubble.match(/ã€Œ([^ã€]+)ã€/);
  if (bracketMatch) {
    jpSample = bracketMatch[1].trim();
  } else {
    // 2ï¸âƒ£ Náº¿u khÃ´ng cÃ³ ã€Œã€, thá»­ tÃ¬m cÃ¡c máº«u khÃ¡c cÃ³ romaji
    const romanjiHintMatch = lastAssistantBubble.match(/([ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯ãƒ¼ãƒ»]+)[^<]*\([A-Za-z\s]+\)/);
    if (romanjiHintMatch) {
      jpSample = romanjiHintMatch[1].trim();
    } else {
      // 3ï¸âƒ£ Náº¿u váº«n khÃ´ng cÃ³, láº¥y dÃ²ng tiáº¿ng Nháº­t dÃ i nháº¥t trong cÃ¢u tráº£ lá»i
      const japaneseMatches = lastAssistantBubble.match(/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯ãƒ¼ãƒ»ã€Œã€]+/g);
      if (japaneseMatches && japaneseMatches.length > 0) {
        jpSample = japaneseMatches.reduce((a, b) => (b.length > a.length ? b : a), "");
      }
    }
  }

  // Náº¿u váº«n khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¢u máº«u
  if (!jpSample) {
    appendMessage('assistant', `<small>âš ï¸ KhÃ´ng tÃ¬m tháº¥y cÃ¢u máº«u Ä‘á»ƒ cháº¥m Ä‘iá»ƒm.</small>`);
    return;
  }

  // ğŸ§® TÃ­nh Ä‘iá»ƒm phÃ¡t Ã¢m
  const score = stringSimilarity(spokenText, jpSample);
  let color = score > 85 ? 'green' : score > 60 ? 'orange' : 'red';

  appendMessage(
    'assistant',
    `ğŸ¯ <b>Äiá»ƒm phÃ¡t Ã¢m:</b> <span style="color:${color}">${score}%</span><br>
     <small>ğŸ—£ï¸ CÃ¢u máº«u: ${jpSample}<br>
     ğŸ“¢ Báº¡n nÃ³i: ${spokenText}</small>`
  );

  // â© Gá»­i cÃ¢u vá»«a nÃ³i cho AI tiáº¿p tá»¥c pháº£n há»“i
  $('#convForm').submit();
};




  recognition.onerror = (event) => {
    console.error('Lá»—i nháº­n giá»ng nÃ³i:', event.error);
    alert('Lá»—i nháº­n giá»ng nÃ³i: ' + event.error);
  };
} else {
  alert('âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n giá»ng nÃ³i (hÃ£y dÃ¹ng Chrome).');
}
// ğŸ“ HÃ m tÃ­nh Ä‘á»™ giá»‘ng giá»¯a hai cÃ¢u (Levenshtein)
function stringSimilarity(s1, s2) {
  s1 = s1.toLowerCase().trim();
  s2 = s2.toLowerCase().trim();

  const len1 = s1.length;
  const len2 = s2.length;
  const dp = Array(len1 + 1)
    .fill(null)
    .map(() => Array(len2 + 1).fill(0));

  for (let i = 0; i <= len1; i++) dp[i][0] = i;
  for (let j = 0; j <= len2; j++) dp[0][j] = j;

  for (let i = 1; i <= len1; i++) {
    for (let j = 1; j <= len2; j++) {
      const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1, // xÃ³a
        dp[i][j - 1] + 1, // thÃªm
        dp[i - 1][j - 1] + cost // thay tháº¿
      );
    }
  }

  const distance = dp[len1][len2];
  const maxLen = Math.max(len1, len2);
  return ((1 - distance / maxLen) * 100).toFixed(1); // pháº§n trÄƒm giá»‘ng
}

$('#micBtn').click(function() {
  if (recognizing) {
    recognition.stop();
    return;
  }
  recognition.start();
});

loadScenarios();
</script>
</body>
</html>
