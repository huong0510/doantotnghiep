<%- include('../partials/header') %>

<div class="container py-5">
  <div class="card shadow border-0 rounded-3 mb-4">
    <div class="card-body">
      <h2 class="text-primary mb-3"><%= grammar.structure %></h2>
      <p class="fs-5"><strong>√ù nghƒ©a:</strong> <%= grammar.meaning %></p>
      <p class="mb-2"><strong>V√≠ d·ª•:</strong></p>

      <blockquote class="border-start ps-3 text-dark">
        <p class="mb-1"><%= grammar.example %></p>
        <small class="text-muted">üëâ <%= grammar.translation %></small>
      </blockquote>

      <a href="/grammar" class="btn btn-outline-primary mt-3">‚¨Ö Quay l·∫°i danh s√°ch</a>

      <!-- N√∫t hi·ªán b√†i luy·ªán t·∫≠p -->
      <button 
        id="show-exercise-btn" 
        class="btn btn-outline-success mt-3"
        data-grammar-id="<%= grammar.id %>"
      >
        üß†Quiz
      </button>

      <!-- V√πng hi·ªÉn th·ªã b√†i luy·ªán t·∫≠p -->
      <div id="exercise-section" class="mt-4" style="display: none;">
        <h4 class="text-success mb-3">B√†i luy·ªán t·∫≠p</h4>
        <div id="exercise-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('show-exercise-btn').addEventListener('click', async (e) => {
  const grammarId = e.target.dataset.grammarId;
  const exerciseSection = document.getElementById('exercise-section');
  const content = document.getElementById('exercise-content');
  
  content.innerHTML = '<p>‚è≥ ƒêang t·∫£i b√†i luy·ªán t·∫≠p...</p>';
  exerciseSection.style.display = 'block';
  
  try {
    const res = await fetch(`/grammar/${grammarId}/exercises`);
    const html = await res.text();
    content.innerHTML = html;

    // üß† Sau khi HTML ƒë∆∞·ª£c render, g·ªçi l·∫°i script ki·ªÉm tra quiz
    initExerciseCheck();
  } catch (err) {
    content.innerHTML = '<p class="text-danger">‚ùå L·ªói khi t·∫£i b√†i luy·ªán t·∫≠p!</p>';
    console.error(err);
  }
});

function initExerciseCheck() {
  document.querySelectorAll(".check-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const quizItem = btn.closest(".quiz-item");
      const correctAnswer = quizItem.dataset.answer.trim();
      const selected = quizItem.querySelector("input[type='radio']:checked");
      const resultDiv = quizItem.querySelector(".result");

      if (!selected) {
        resultDiv.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!";
        resultDiv.className = "result mt-2 fw-semibold text-warning";
        return;
      }

      if (selected.value === correctAnswer) {
        resultDiv.textContent = "‚úÖ Ch√≠nh x√°c!";
        resultDiv.className = "result mt-2 fw-semibold text-success";
      } else {
        resultDiv.textContent = `‚ùå Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${correctAnswer}.`;
        resultDiv.className = "result mt-2 fw-semibold text-danger";
      }
    });
  });
}
</script>

<%- include('../partials/footer') %>
