<%- include('../partials/header') %>

<div class="container py-5">
  <div class="card shadow border-0 rounded-3 mb-4">
    <div class="card-body">
    <!-- üìò Flashcard hi·ªáu ·ª©ng l·∫≠t + √¢m thanh + t·ª± l·∫≠t -->
<div class="flashcard mx-auto my-4" id="grammarCard">
  <div class="card-inner">
    <!-- M·∫∑t tr∆∞·ªõc -->
    <div class="card-face card-front">
      <h2 class="fw-bold text-primary"><%= grammar.structure %></h2>
      <p class="text-muted mt-3">üí° Nh·∫•n ƒë·ªÉ xem √Ω nghƒ©a & v√≠ d·ª•</p>
    </div>

    <!-- M·∫∑t sau -->
    <div class="card-face card-back text-center">
      <p class="fs-5"><strong>√ù nghƒ©a:</strong> <%= grammar.meaning %></p>
      <blockquote class="border-start ps-3 text-dark">
        <p class="mb-1"><%= grammar.example %></p>
        <small class="text-muted">üëâ <%= grammar.translation %></small>
      </blockquote>
    </div>
  </div>
</div>

<style>
  .flashcard {
    width: 100%;
    max-width: 600px;
    height: 250px;
    perspective: 1000px;
    cursor: pointer;
    position: relative;
    transition: transform 0.3s ease;
  }

  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.8s;
    transform-style: preserve-3d;
  }

  .flashcard.flipped .card-inner {
    transform: rotateY(180deg);
  }

  .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    backface-visibility: hidden;
    background: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 25px;
  }

  .card-front {
    background: linear-gradient(135deg, #e3f2fd, #f8fafc);
    color: #0d47a1;
  }

  .card-back {
    transform: rotateY(180deg);
    background: #f9fafb;
    color: #111827;
  }

  /* üåü Hi·ªáu ·ª©ng glow khi hover */
  .flashcard:hover {
    transform: scale(1.03);
    box-shadow: 0 10px 25px rgba(0, 123, 255, 0.2);
  }

  /* üé∂ Animation l·∫≠t */
  @keyframes flipSoundGlow {
    0% { box-shadow: 0 0 0px rgba(33,150,243,0.4); }
    50% { box-shadow: 0 0 30px rgba(33,150,243,0.7); }
    100% { box-shadow: 0 0 0px rgba(33,150,243,0.4); }
  }
</style>

<script>
 const grammarCard = document.getElementById("grammarCard");

// üîä N·∫°p √¢m thanh khi l·∫≠t (ƒë·∫∑t trong th∆∞ m·ª•c public/sounds)
const flipSound = new Audio("/sounds/pop-94319.mp3");

// Khi nh·∫•p ƒë·ªÉ l·∫≠t
grammarCard.addEventListener("click", () => {
  grammarCard.classList.toggle("flipped");

  // Ph√°t √¢m thanh (reset n·∫øu ƒëang ph√°t)
  flipSound.currentTime = 0;
  flipSound.play().catch(err => console.warn("Kh√¥ng ph√°t ƒë∆∞·ª£c √¢m thanh:", err));

  // Hi·ªáu ·ª©ng s√°ng nh·∫π khi l·∫≠t
  grammarCard.style.animation = "flipGlow 0.5s ease";
  setTimeout(() => grammarCard.style.animation = "", 500);
});

// ‚è≥ T·ª± l·∫≠t sau 3 gi√¢y n·∫øu ch∆∞a l·∫≠t
setTimeout(() => {
  if (!grammarCard.classList.contains("flipped")) {
    grammarCard.classList.add("flipped");
    flipSound.currentTime = 0;
    flipSound.play();
  }
}, 3000);
</script>


    

      <a href="/grammar" class="btn btn-outline-primary mt-3">‚¨Ö Quay l·∫°i danh s√°ch</a>

      <!-- N√∫t hi·ªán b√†i luy·ªán t·∫≠p -->
      <button 
        id="show-exercise-btn" 
        class="btn btn-outline-success mt-3"
        data-grammar-id="<%= grammar.id %>"
      >
        üß†Quiz
      </button>

      <!-- V√πng hi·ªÉn th·ªã b√†i luy·ªán t·∫≠p -->
<div id="exercise-section" class="mt-4" style="display: none;">
  <h4 class="text-success mb-3">B√†i luy·ªán t·∫≠p</h4>
  <div id="exercise-content"></div>

<!-- N√∫t ph√¢n t√≠ch ƒë·∫∑t ngay d∆∞·ªõi b√†i t·∫≠p -->
<div class="text-start mt-3">
  <button 
    id="analyze-btn" 
    class="btn btn-info d-flex align-items-center gap-2"
    style="display: none;"
  >
    <span id="loading-spinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
    <span id="analyze-text">ü§ñ Ph√¢n t√≠ch ƒëi·ªÉm y·∫øu</span>
  </button>
</div>



<!-- K·∫øt qu·∫£ ph√¢n t√≠ch AI -->
<div id="aiAnalysis" class="mt-4 p-4 border rounded bg-light shadow-sm" style="display:none;">
  <h5 class="text-primary mb-3">ü§ñ k·∫øt qu·∫£ ph√¢n t√≠ch</h5>
  <div id="aiResult" class="text-dark" style="white-space: pre-line;"></div>
</div>


<script>
document.getElementById('show-exercise-btn').addEventListener('click', async (e) => {
  const grammarId = e.target.dataset.grammarId;
  const section = document.getElementById('exercise-section');
  const content = document.getElementById('exercise-content');
  const analyzeBtn = document.getElementById("analyze-btn");

  content.innerHTML = '<p>‚è≥ ƒêang t·∫£i b√†i luy·ªán t·∫≠p...</p>';
  section.style.display = 'block';
  analyzeBtn.style.display = 'none';
  document.getElementById("aiAnalysis").style.display = "none";

  try {
    const res = await fetch(`/grammar/${grammarId}/exercises`);
    const html = await res.text();
    content.innerHTML = html;
    initExerciseCheck();
  } catch (err) {
    content.innerHTML = '<p class="text-danger">‚ùå L·ªói khi t·∫£i b√†i luy·ªán t·∫≠p!</p>';
    console.error(err);
  }
});

function initExerciseCheck() {
  const analyzeBtn = document.getElementById("analyze-btn");
  analyzeBtn.style.display = "none"; // ·∫©n ban ƒë·∫ßu

  document.querySelectorAll(".check-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const quizDiv = btn.closest(".quiz-item");
      const selected = quizDiv.querySelector("input[type='radio']:checked");
      const resultDiv = quizDiv.querySelector(".result");

      if (!selected) {
        resultDiv.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!";
        resultDiv.className = "result mt-2 fw-semibold text-warning";
        return;
      }

      const correctAnswer = quizDiv.dataset.answer?.trim();
      if (selected.value === correctAnswer) {
        resultDiv.textContent = "‚úÖ Ch√≠nh x√°c!";
        resultDiv.className = "result mt-2 fw-semibold text-success";
      } else {
        resultDiv.textContent = `‚ùå Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${correctAnswer}.`;
        resultDiv.className = "result mt-2 fw-semibold text-danger";
      }

      // ‚úÖ Ki·ªÉm tra xem t·∫•t c·∫£ quiz-item ƒë·ªÅu ƒë√£ c√≥ c√¢u tr·∫£ l·ªùi
      const allAnswered = [...document.querySelectorAll(".quiz-item")].every((item) => {
        return item.querySelector("input[type='radio']:checked");
      });

      if (allAnswered) {
        const grammarId = document.getElementById("show-exercise-btn").dataset.grammarId;
        enableAIButton(grammarId);
      }
    });
  });
}

// üß† G·ªçi AI
async function analyzeWeakness(grammarId, quizResults) {
  const res = await fetch("/grammar/analyze", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ grammarId, quizResults })
  });

  const data = await res.json();
  const aiDiv = document.getElementById("aiAnalysis");
  const aiResult = document.getElementById("aiResult");

  aiDiv.style.display = "block";

  if (data.success) {
    const formatted = data.analysis
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\* (.*?)\n/g, "‚Ä¢ $1<br>")
      .replace(/\n\n/g, "<br><br>")
      .replace(/\n/g, "<br>");
    aiResult.innerHTML = `<div class="p-3 bg-white rounded shadow-sm border-start border-4 border-primary">${formatted}</div>`;
  } else {
    aiResult.innerHTML = `<span class="text-danger">‚ùå Ph√¢n t√≠ch th·∫•t b·∫°i!</span>`;
  }
}

// ‚úÖ Hi·ªán n√∫t AI ƒë√∫ng l√∫c & c√≥ hi·ªáu ·ª©ng ch·ªù
function enableAIButton(grammarId) {
  const btn = document.getElementById("analyze-btn");
  btn.style.display = "inline-flex";

  btn.onclick = async () => {
    const quizResults = [];
    document.querySelectorAll(".quiz-item").forEach(item => {
      const question = item.querySelector(".question-text")?.textContent?.trim();
      const selected = item.querySelector("input[type='radio']:checked");
      const correctAnswer = item.dataset.answer?.trim();
      if (question && correctAnswer) {
        quizResults.push({
          question,
          userAnswer: selected ? selected.value : null,
          correctAnswer
        });
      }
    });

    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>ƒêang ph√¢n t√≠ch...`;

    try {
      await analyzeWeakness(grammarId, quizResults);
    } catch (err) {
      alert("‚ùå L·ªói khi ph√¢n t√≠ch");
      console.error(err);
    } finally {
      btn.disabled = false;
      btn.innerHTML = "ü§ñ Ph√¢n t√≠ch ƒëi·ªÉm y·∫øu";
    }
  };
}
</script>



<%- include('../partials/footer') %>
