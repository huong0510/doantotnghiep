<%- include('partials/header', { title: 'K·∫ø ho·∫°ch h·ªçc t·∫≠p AI' }) %>

<div class="container mt-5">
  <h1 class="text-center mb-4" style="font-family: 'Playfair Display', serif;">üß† K·∫ø ho·∫°ch h·ªçc t·∫≠p</h1>

  <form id="planForm" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label>T√™n h·ªçc vi√™n</label>
      <input type="text" name="name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Tr√¨nh ƒë·ªô hi·ªán t·∫°i</label>
      <select name="level" class="form-select">
        <option value="N5">N5</option>
        <option value="N4">N4</option>
        <option value="N3">N3</option>
      </select>
    </div>

    <div class="mb-3">
      <label>M·ª•c ti√™u h·ªçc t·∫≠p</label>
      <input type="text" name="goals" class="form-control" placeholder="V√≠ d·ª•: Giao ti·∫øp c∆° b·∫£n, thi JLPT N4...">
    </div>

    <div class="mb-3">
      <label>K·ªπ nƒÉng y·∫øu</label>
      <input type="text" name="weakPoints" class="form-control" placeholder="V√≠ d·ª•: ng·ªØ ph√°p...">
    </div>

    <div class="mb-3">
      <label>Th·ªùi gian h·ªçc m·ªói ng√†y</label>
      <input type="text" name="availableTime" class="form-control" placeholder="V√≠ d·ª•: 30 ph√∫t/ng√†y">
    </div>

    <button type="submit" class="btn btn-primary w-100">‚ú® T·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p</button>
  </form>

  <div id="planResult" class="mt-5">
    <div id="loading" class="text-center" style="display:none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">ƒêang t·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p cho b·∫°n...</p>
    </div>
    <div id="planCards" class="row gy-4"></div>

    <!-- ‚úÖ Th√™m n√∫t l∆∞u v√† xem l·ªãch s·ª≠ -->
    <div class="text-center mt-4">
      <button id="savePlanBtn" class="btn btn-success d-none">üíæ L∆∞u k·∫ø ho·∫°ch</button>
<!-- N√∫t Xem l·ªãch s·ª≠ -->
<div class="text-center mt-5 mb-5">
  <a href="/learning-plan/history-view" 
     class="btn btn-info fw-bold px-4 py-2 shadow-sm"
     style="background: linear-gradient(90deg, #00bfff, #007bff); border: none; border-radius: 8px;">
    üìò Xem l·ªãch s·ª≠
  </a>
</div>
    </div>
  </div>
</div>

<script>
let currentPlan = null;

document.querySelector("#planForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = Object.fromEntries(new FormData(e.target).entries());
  const btn = e.target.querySelector("button[type='submit']");
  const loading = document.querySelector("#loading");
  const cardContainer = document.querySelector("#planCards");

  cardContainer.innerHTML = "";
  loading.style.display = "block";
  btn.disabled = true;

  try {
    const res = await fetch("/learning-plan/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

   const data = await res.json();
let planText = data.plan || "‚ùå Kh√¥ng t·∫°o ƒë∆∞·ª£c k·∫ø ho·∫°ch h·ªçc.";

// ‚úÖ L∆∞u k·∫ø ho·∫°ch hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ l∆∞u DB
currentPlan = {
  student_name: formData.name,
  level: formData.level,
  goals: formData.goals,
  weak_points: formData.weakPoints,
  available_time: formData.availableTime,
  plan: planText
};

// ‚úÖ Hi·ªán n√∫t ‚ÄúL∆∞u k·∫ø ho·∫°ch‚Äù
document.getElementById("savePlanBtn").classList.remove("d-none");
    // T√°ch k·∫ø ho·∫°ch theo "Ng√†y", "Bu·ªïi", ho·∫∑c "B√†i"
// ‚úÖ X·ª≠ l√Ω markdown -> HTML
let formatted = planText
  .replace(/^### (.*$)/gim, '<h3 class="fw-bold mt-3 text-primary">$1</h3>')
  .replace(/^## (.*$)/gim, '<h4 class="fw-semibold mt-3 text-primary">$1</h4>')
  .replace(/^# (.*$)/gim, '<h5 class="fw-semibold mt-3 text-primary">$1</h5>')
  .replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>')
  .replace(/\*(.*?)\*/gim, '<i>$1</i>')
  .replace(/\n/g, '<br>')
  .replace(/\[(.*?)\]\((.*?)\)/g, `<a href="$2" target="_blank" class="text-decoration-underline text-info">$1</a>`);

// ‚úÖ Hi·ªÉn th·ªã d·∫°ng th·∫ª ƒë·∫πp
cardContainer.innerHTML = `
  <div class="card shadow-sm p-4">
    <h4 class="text-center text-success mb-3">üìã Chi ti·∫øt k·∫ø ho·∫°ch h·ªçc</h4>
    <div class="text-dark" style="white-space: normal; line-height: 1.7;">${formatted}</div>
  </div>
`;
  } catch (err) {
    console.error(err);
    cardContainer.innerHTML = `<div class="alert alert-danger">‚ùå L·ªói khi g·ªçi AI ho·∫∑c server kh√¥ng ph·∫£n h·ªìi.</div>`;
  } finally {
    loading.style.display = "none";
    btn.disabled = false;
  }
});

// ‚úÖ X·ª≠ l√Ω khi b·∫•m ‚ÄúL∆∞u k·∫ø ho·∫°ch‚Äù
document.getElementById("savePlanBtn").addEventListener("click", async () => {
  if (!currentPlan) return alert("‚ö† Kh√¥ng c√≥ k·∫ø ho·∫°ch ƒë·ªÉ l∆∞u!");

  const res = await fetch("/learning-plan/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(currentPlan)
  });

  if (res.ok) {
    alert("‚úÖ ƒê√£ l∆∞u k·∫ø ho·∫°ch th√†nh c√¥ng!");
    document.getElementById("savePlanBtn").classList.add("d-none");
  } else {
    alert("‚ùå L·ªói khi l∆∞u k·∫ø ho·∫°ch!");
  }
});
</script>

<style>
.card-header {
  font-size: 1.1rem;
}
a {
  color: #0d6efd;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
#planCards h3, #planCards h4, #planCards h5 {
  color: #0d6efd;
  margin-top: 1rem;
}

#planCards b {
  color: #212529;
}

#planCards i {
  color: #555;
}

#planCards a {
  color: #0dcaf0;
  text-decoration: underline;
}
.text-center.mt-5.mb-5 {
    margin-top: 60px !important;
    margin-bottom: 60px !important;
  }
</style>

<%- include('partials/footer') %>
