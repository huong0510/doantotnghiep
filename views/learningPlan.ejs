<%- include('partials/header', { title: 'K·∫ø ho·∫°ch h·ªçc t·∫≠p AI' }) %>

<div class="container mt-5">
  <h1 class="text-center mb-4" style="font-family: 'Playfair Display', serif;">üß† K·∫ø ho·∫°ch h·ªçc t·∫≠p AI</h1>

  <form id="planForm" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label>T√™n h·ªçc vi√™n</label>
      <input type="text" name="name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Tr√¨nh ƒë·ªô hi·ªán t·∫°i</label>
      <select name="level" class="form-select">
        <option value="N5">N5</option>
        <option value="N4">N4</option>
        <option value="N3">N3</option>
      </select>
    </div>

    <div class="mb-3">
      <label>M·ª•c ti√™u h·ªçc t·∫≠p</label>
      <input type="text" name="goals" class="form-control" placeholder="V√≠ d·ª•: Giao ti·∫øp c∆° b·∫£n, thi JLPT N4...">
    </div>

    <div class="mb-3">
      <label>K·ªπ nƒÉng y·∫øu</label>
      <input type="text" name="weakPoints" class="form-control" placeholder="V√≠ d·ª•: ng·ªØ ph√°p...">
    </div>

    <div class="mb-3">
      <label>Th·ªùi gian h·ªçc m·ªói ng√†y</label>
      <input type="text" name="availableTime" class="form-control" placeholder="V√≠ d·ª•: 30 ph√∫t/ng√†y">
    </div>

    <button type="submit" class="btn btn-primary w-100">‚ú® T·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p</button>
  </form>

  <div id="planResult" class="mt-5">
    <div id="loading" class="text-center" style="display:none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">ƒêang t·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p cho b·∫°n...</p>
    </div>
    <div id="planCards" class="row gy-4"></div>

    <!-- ‚úÖ Th√™m n√∫t l∆∞u v√† xem l·ªãch s·ª≠ -->
    <div class="text-center mt-4">
      <button id="savePlanBtn" class="btn btn-success d-none">üíæ L∆∞u k·∫ø ho·∫°ch</button>
<a href="/learning-plan/history-view" class="btn btn-info">üìú Xem l·ªãch s·ª≠</a>
    </div>
  </div>
</div>

<script>
let currentPlan = null;

document.querySelector("#planForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = Object.fromEntries(new FormData(e.target).entries());
  const btn = e.target.querySelector("button[type='submit']");
  const loading = document.querySelector("#loading");
  const cardContainer = document.querySelector("#planCards");

  cardContainer.innerHTML = "";
  loading.style.display = "block";
  btn.disabled = true;

  try {
    const res = await fetch("/learning-plan/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const data = await res.json();
    let planText = data.plan || "‚ùå Kh√¥ng t·∫°o ƒë∆∞·ª£c k·∫ø ho·∫°ch h·ªçc.";

    // ‚úÖ L∆∞u l·∫°i k·∫ø ho·∫°ch hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ l∆∞u DB
   currentPlan = {
  student_name: formData.name,
  level: formData.level,
  goals: formData.goals,
  weak_points: formData.weakPoints,
  available_time: formData.availableTime,
  plan: planText
};
 // ‚úÖ Hi·ªán n√∫t ‚ÄúL∆∞u k·∫ø ho·∫°ch‚Äù
document.getElementById("savePlanBtn").classList.remove("d-none");

    // T√°ch k·∫ø ho·∫°ch theo "Ng√†y", "Bu·ªïi", ho·∫∑c "B√†i"
    const sections = planText.split(/(?=Ng√†y\s*\d+|Bu·ªïi\s*\d+|B√†i\s*\d+)/gi);

    if (sections.length <= 1) {
      // N·∫øu kh√¥ng t√°ch ƒë∆∞·ª£c ‚Üí hi·ªÉn th·ªã d·∫°ng vƒÉn b·∫£n
      cardContainer.innerHTML = `<div class="alert alert-info">${planText.replace(/\n/g, "<br>")}</div>`;
    } else {
      sections.forEach((section, index) => {
        const titleMatch = section.match(/(Ng√†y\s*\d+|Bu·ªïi\s*\d+|B√†i\s*\d+)/i);
        const title = titleMatch ? titleMatch[0] : `Ph·∫ßn ${index + 1}`;
        const content = section
          .replace(title, "")
          .replace(/\n/g, "<br>")
          .replace(/\[(.*?)\]\((.*?)\)/g, `<a href="$2" target="_blank">$1</a>`)
          .replace(/\b(ng·ªØ ph√°p|t·ª´ v·ª±ng|nghe|n√≥i|ƒë·ªçc hi·ªÉu|√¥n t·∫≠p|m·ª•c ti√™u)\b/gi,
                   `<span class="fw-bold text-success">$1</span>`);

        const cardHTML = `
          <div class="col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-primary text-white fw-bold">${title}</div>
              <div class="card-body">${content}</div>
            </div>
          </div>
        `;
        cardContainer.insertAdjacentHTML("beforeend", cardHTML);
      });
    }
  } catch (err) {
    console.error(err);
    cardContainer.innerHTML = `<div class="alert alert-danger">‚ùå L·ªói khi g·ªçi AI ho·∫∑c server kh√¥ng ph·∫£n h·ªìi.</div>`;
  } finally {
    loading.style.display = "none";
    btn.disabled = false;
  }
});

// ‚úÖ X·ª≠ l√Ω khi b·∫•m ‚ÄúL∆∞u k·∫ø ho·∫°ch‚Äù
document.getElementById("savePlanBtn").addEventListener("click", async () => {
  if (!currentPlan) return alert("‚ö† Kh√¥ng c√≥ k·∫ø ho·∫°ch ƒë·ªÉ l∆∞u!");

  const res = await fetch("/learning-plan/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(currentPlan)
  });

  if (res.ok) {
    alert("‚úÖ ƒê√£ l∆∞u k·∫ø ho·∫°ch th√†nh c√¥ng!");
    document.getElementById("savePlanBtn").classList.add("d-none");
  } else {
    alert("‚ùå L·ªói khi l∆∞u k·∫ø ho·∫°ch!");
  }
});
</script>

<style>
.card-header {
  font-size: 1.1rem;
}
a {
  color: #0d6efd;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
</style>

<%- include('partials/footer') %>
