<%- include('partials/header', { title: 'K·∫ø ho·∫°ch h·ªçc t·∫≠p AI' }) %>

<div class="container mt-5">
  <h1 class="text-center mb-4 title-ai">üß† K·∫ø ho·∫°ch h·ªçc t·∫≠p AI</h1>

  <form id="planForm" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label>T√™n h·ªçc vi√™n</label>
      <input type="text" name="name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Tr√¨nh ƒë·ªô hi·ªán t·∫°i</label>
      <select name="level" class="form-select">
        <option value="N5">N5</option>
        <option value="N4">N4</option>
        <option value="N3">N3</option>
      </select>
    </div>

    <div class="mb-3">
      <label>M·ª•c ti√™u h·ªçc t·∫≠p</label>
      <input type="text" name="goals" class="form-control" placeholder="V√≠ d·ª•: Giao ti·∫øp c∆° b·∫£n, thi JLPT N4...">
    </div>

    <div class="mb-3">
      <label>K·ªπ nƒÉng y·∫øu</label>
      <input type="text" name="weakPoints" class="form-control" placeholder="V√≠ d·ª•: Ng·ªØ ph√°p...">
    </div>

    <div class="mb-3">
      <label>Th·ªùi gian h·ªçc m·ªói ng√†y</label>
      <input type="text" name="availableTime" class="form-control" placeholder="V√≠ d·ª•: 30 ph√∫t/ng√†y">
    </div>

    <button type="submit" class="btn btn-primary w-100">‚ú® T·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p</button>
  </form>

  <!-- K·∫øt qu·∫£ k·∫ø ho·∫°ch -->
  <div id="planResult" class="mt-5">
    <div id="loading" class="loading-box text-center" style="display:none;">
      <div class="spinner-border" role="status"></div>
      <p class="mt-3 text-danger fw-semibold">AI ƒëang t·∫°o k·∫ø ho·∫°ch h·ªçc t·∫≠p cho b·∫°n...</p>
    </div>

    <div id="planCards" class="fade-in-section"></div>

    <div class="text-center mt-4">
      <button id="savePlanBtn" class="btn btn-success d-none">üíæ L∆∞u k·∫ø ho·∫°ch</button>
    </div>

    <div class="text-center mt-5 mb-5">
      <a href="/learning-plan/history-view" class="btn btn-outline-danger fw-bold px-4 py-2 shadow-sm">
        üìò Xem l·ªãch s·ª≠
      </a>
    </div>
  </div>
</div>

<script>
let currentPlan = null;

document.querySelector("#planForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = Object.fromEntries(new FormData(e.target).entries());
  const btn = e.target.querySelector("button[type='submit']");
  const loading = document.querySelector("#loading");
  const cardContainer = document.querySelector("#planCards");

  cardContainer.innerHTML = "";
  loading.style.display = "block";
  btn.disabled = true;

  try {
    const res = await fetch("/learning-plan/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const data = await res.json();
    let planText = data.plan || "‚ùå Kh√¥ng t·∫°o ƒë∆∞·ª£c k·∫ø ho·∫°ch h·ªçc.";

    // ‚úÖ L∆∞u k·∫ø ho·∫°ch hi·ªán t·∫°i
    currentPlan = {
      student_name: formData.name,
      level: formData.level,
      goals: formData.goals,
      weak_points: formData.weakPoints,
      available_time: formData.availableTime,
      plan: planText
    };

    document.getElementById("savePlanBtn").classList.remove("d-none");

    // ‚úÖ T√°ch n·ªôi dung theo "Ng√†y" ho·∫∑c "Bu·ªïi"
    const sections = planText.split(/(?=Ng√†y\s+\d+|Bu·ªïi\s+\d+)/g);

    cardContainer.innerHTML = `<h4 class="text-center text-danger fw-bold mb-4">üìã K·∫ø ho·∫°ch chi ti·∫øt c·ªßa b·∫°n</h4>`;

    // ‚úÖ G√µ t·ª´ng ng√†y k√®m icon ph√π h·ª£p
    for (let i = 0; i < sections.length; i++) {
      const section = sections[i].trim();
      if (!section) continue;

      const icon = detectIcon(section);
      const card = document.createElement("div");
      card.className = "ai-plan-card";

      const title = section.split("\n")[0];
      const content = section.substring(title.length).trim();

      card.innerHTML = `
        <div class="ai-plan-title">${icon} ${title}</div>
        <div class="ai-plan-content"></div>
      `;
      cardContainer.appendChild(card);

      const contentDiv = card.querySelector(".ai-plan-content");
      await typeText(contentDiv, content);
    }
  } catch (err) {
    console.error(err);
    cardContainer.innerHTML = `<div class="alert alert-danger">‚ùå L·ªói khi g·ªçi AI ho·∫∑c server kh√¥ng ph·∫£n h·ªìi.</div>`;
  } finally {
    loading.style.display = "none";
    btn.disabled = false;
  }
});

// üß† T·ª± ch·ªçn icon theo n·ªôi dung
function detectIcon(text) {
  text = text.toLowerCase();
  if (text.includes("nghe")) return "üéß";
  if (text.includes("n√≥i")) return "üó£Ô∏è";
  if (text.includes("ƒë·ªçc")) return "üìñ";
  if (text.includes("vi·∫øt")) return "‚úçÔ∏è";
  if (text.includes("ng·ªØ ph√°p")) return "üß©";
  if (text.includes("t·ª´ v·ª±ng")) return "ü™Ñ";
  if (text.includes("√¥n t·∫≠p")) return "üîÅ";
  if (text.includes("kanji")) return "üà∂";
  return "üìò";
}

// ‚ú® Hi·ªáu ·ª©ng g√µ ch·ªØ
function typeText(element, text) {
  return new Promise((resolve) => {
    let i = 0;
    function typing() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, 15);
      } else {
        resolve();
      }
    }
    typing();
  });
}

// üíæ L∆∞u k·∫ø ho·∫°ch
document.getElementById("savePlanBtn").addEventListener("click", async () => {
  if (!currentPlan) return alert("‚ö† Kh√¥ng c√≥ k·∫ø ho·∫°ch ƒë·ªÉ l∆∞u!");

  const res = await fetch("/learning-plan/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(currentPlan)
  });

  if (res.ok) {
    alert("‚úÖ ƒê√£ l∆∞u k·∫ø ho·∫°ch th√†nh c√¥ng!");
    document.getElementById("savePlanBtn").classList.add("d-none");
  } else {
    alert("‚ùå L·ªói khi l∆∞u k·∫ø ho·∫°ch!");
  }
});
</script>

<style>
body {
  background-color: #fff;
  font-family: "Poppins", "Segoe UI", sans-serif;
}

/* üå∏ Ti√™u ƒë·ªÅ */
h1 {
  color: #b52b39;
  font-weight: 800;
  text-shadow: 1px 1px 4px rgba(255, 0, 0, 0.15);
}

/* üßæ Form */
.card {
  border: 2px solid #f8d7da;
  border-radius: 18px;
  background: #ffffff;
  padding: 35px;
  box-shadow: 0 6px 16px rgba(211, 47, 47, 0.1);
}

/* N√∫t ch√≠nh */
.btn-primary {
  background-color: #dc3545;
  border: none;
  border-radius: 12px;
  padding: px;
  font-weight: 600;
  transition: 0.25s ease;
}
.btn-primary:hover {
  background-color: #b71c1c;
  transform: translateY(-2px);
  box-shadow: 0 5px 14px rgba(211, 47, 47, 0.35);
}

/* üåà K·∫ø ho·∫°ch AI */
#planCards {
  margin-top: 30px;
}
.ai-plan-card {
  background: #fff;
  border-left: 6px solid #dc3545;
  border-radius: 14px;
  padding: 18px 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 10px rgba(211, 47, 47, 0.1);
  opacity: 0;
  animation: fadeIn 0.8s forwards;
}
.ai-plan-card:nth-child(even) {
  border-left-color: #ff8a80;
}
.ai-plan-title {
  font-weight: 700;
  color: #b52b39;
  margin-bottom: 8px;
  font-size: 1.1rem;
}
.ai-plan-content {
  white-space: pre-line;
  line-height: 1.6;
  color: #333;
  font-size: 1rem;
}

/* Animation */
@keyframes fadeIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
  from {
    opacity: 0;
    transform: translateY(15px);
  }
}
</style>

<%- include('partials/footer') %>
