<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Lá»‹ch sá»­ káº¿ hoáº¡ch há»c</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f7f9fc;
    }

    .card-day {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      padding: 15px 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .card-day:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }

    .card-day h5 {
      color: #007bff;
      font-weight: 600;
    }

    .modal-body {
      max-height: 75vh;
      overflow-y: auto;
    }

    .progress {
      background-color: #e9ecef;
      border-radius: 10px;
    }

    .progress-bar {
      background: linear-gradient(90deg, #00bfff, #007bff);
      font-weight: 600;
    }

    .btn-status {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4">ğŸ“œ Lá»‹ch sá»­ káº¿ hoáº¡ch há»c</h2>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>TÃªn há»c viÃªn</th>
          <th>TrÃ¬nh Ä‘á»™</th>
          <th>NgÃ y táº¡o</th>
          <th>Chi tiáº¿t</th>
          <th>HÃ nh Ä‘á»™ng</th>
        </tr>
      </thead>
      <tbody id="planList">
        <tr><td colspan="6" class="text-center">Äang táº£i dá»¯ liá»‡u...</td></tr>
      </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center my-3">
      <a href="/learning-plan" class="btn btn-secondary">â† Quay láº¡i táº¡o káº¿ hoáº¡ch</a>

      <div class="d-flex align-items-center gap-2">
        <input type="number" id="planIdInput" class="form-control" placeholder="Nháº­p ID káº¿ hoáº¡ch..." style="width: 180px;">
        <button class="btn btn-info fw-bold shadow-sm"
          style="background: linear-gradient(90deg, #00bfff, #007bff); border: none;"
          onclick="goToAnalysis()">
          ğŸ¤– PhÃ¢n tÃ­ch nÄƒng lá»±c (AI)
        </button>
      </div>
    </div>
  </div>

  <!-- Modal chi tiáº¿t káº¿ hoáº¡ch -->
  <div class="modal fade" id="planModal" tabindex="-1" aria-labelledby="planModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="planModalLabel">Chi tiáº¿t káº¿ hoáº¡ch há»c</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="planDetail">Äang táº£i...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ğŸ¯ Chuyá»ƒn Ä‘áº¿n trang phÃ¢n tÃ­ch nÄƒng lá»±c
    function goToAnalysis() {
      const id = document.getElementById('planIdInput').value.trim();
      if (!id) return alert('âš ï¸ Vui lÃ²ng nháº­p ID káº¿ hoáº¡ch trÆ°á»›c khi phÃ¢n tÃ­ch!');
      window.location.href = '/learning-plan/analysis/' + id;
    }

    // ğŸ“œ Load danh sÃ¡ch káº¿ hoáº¡ch há»c
    async function loadPlans() {
      const res = await fetch('/learning-plan/history');
      const plans = await res.json();
      const tbody = document.getElementById('planList');
      tbody.innerHTML = '';

      if (plans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ChÆ°a cÃ³ káº¿ hoáº¡ch nÃ o.</td></tr>';
        return;
      }

      plans.forEach(plan => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${plan.id}</td>
          <td>${plan.student_name}</td>
          <td>${plan.level}</td>
          <td>${new Date(plan.created_at).toLocaleString()}</td>
          <td><button class="btn btn-sm btn-primary" onclick="viewPlan(${plan.id})">ğŸ‘€ Xem</button></td>
          <td><button class="btn btn-sm btn-danger" onclick="deletePlan(${plan.id})">ğŸ—‘ XÃ³a</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ğŸ‘€ Xem chi tiáº¿t káº¿ hoáº¡ch + tiáº¿n Ä‘á»™
    async function viewPlan(id) {
      const res = await fetch('/learning-plan/' + id);
      const plan = await res.json();
      const content = plan.plan || 'KhÃ´ng cÃ³ ná»™i dung.';

      // ğŸŸ© Khá»‘i hiá»ƒn thá»‹ tiáº¿n Ä‘á»™
     // ğŸŸ© Khá»‘i hiá»ƒn thá»‹ tiáº¿n Ä‘á»™ + nháº­t kÃ½
const progressSection = `
  <div class="my-4">
    <h5>ğŸ“Š Tiáº¿n Ä‘á»™ há»c</h5>
    <div class="progress mb-3">
      <div id="progress-bar" class="progress-bar bg-success" style="width: 0%">0%</div>
    </div>
    <div id="progress-list" class="list-group small mb-3"></div>
    <div id="init-progress-div" class="text-center d-none">
      <button class="btn btn-outline-primary btn-sm" id="init-progress-btn">âš¡ Khá»Ÿi táº¡o tiáº¿n Ä‘á»™</button>
    </div>
  </div>

  <!-- ğŸ“˜ Nháº­t kÃ½ há»c táº­p -->
  <div class="my-4">
    <h5>ğŸ“ Nháº­t kÃ½ há»c táº­p</h5>
    <div class="mb-2">
      <label class="form-label small fw-bold text-muted">Chá»n giai Ä‘oáº¡n:</label>
      <select id="journalStage" class="form-select form-select-sm w-auto d-inline-block">
  <option disabled selected>Äang táº£i...</option>
</select>

    </div>

   <textarea id="journalNote" class="form-control mb-2" rows="3" placeholder="âœï¸ Ghi chÃº cáº£m nháº­n, tiáº¿n bá»™ hoáº·c khÃ³ khÄƒn..."></textarea>

<div class="d-flex justify-content-between align-items-center mb-3">
  <button class="btn btn-sm btn-success px-3" onclick="saveJournal(${id})">ğŸ’¾ LÆ°u nháº­t kÃ½</button>
  <button class="btn btn-outline-primary btn-sm px-3" onclick="toggleJournalView(${id})">ğŸ“– Xem nháº­t kÃ½</button>
</div>

<div id="journalHistory" class="mt-3" style="display: none;"></div>


`;

      
      

      // Chuyá»ƒn markdown â†’ HTML
      const html = marked.parse(content);
      const sections = html.split(/<h3.*?>/g).filter(s => s.trim() !== '');
      let rendered = '';

      if (sections.length > 1) {
        sections.forEach((section, index) => {
          rendered += `
            <div class="card-day">
              <h5>NgÃ y ${index + 1}</h5>
              <div>${section}</div>
            </div>`;
        });
      } else {
        rendered = `<div class="card-day">${html}</div>`;
      }

      // Render toÃ n bá»™ ná»™i dung vÃ o modal
      document.getElementById('planDetail').innerHTML = progressSection + rendered;

      // âš¡ GÃ¡n sá»± kiá»‡n khá»Ÿi táº¡o tiáº¿n Ä‘á»™
      document.getElementById('init-progress-btn').onclick = () => initProgress(id);

      const modal = new bootstrap.Modal(document.getElementById('planModal'));
      modal.show();

      // ğŸ”„ Táº£i tiáº¿n Ä‘á»™ há»c
      loadProgress(id);
    }
// ğŸ“Š Render progress tá»« server
// ğŸ”„ Render progress
function renderProgress(progress, planId) {
  const modalBody = document.getElementById('planDetail');
  const listDiv = modalBody.querySelector('#progress-list');
  const bar = modalBody.querySelector('#progress-bar');

  listDiv.innerHTML = '';

  const totalDays = progress.length;
  const completedDays = progress.filter(p => p.status === 'completed').length;
  const percent = Math.round((completedDays / totalDays) * 100);

  bar.style.width = percent + '%';
  bar.innerText = percent + '%';

  // ğŸ§  Cáº­p nháº­t danh sÃ¡ch giai Ä‘oáº¡n trong Nháº­t kÃ½ há»c táº­p
  const stageSelect = document.getElementById('journalStage');
  if (stageSelect) {
    stageSelect.innerHTML = ''; // XÃ³a cÅ©
    progress.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.day_number;
      opt.textContent = `Giai Ä‘oáº¡n ${p.day_number}`;
      stageSelect.appendChild(opt);
    });
  }

  // ğŸŸ© Hiá»ƒn thá»‹ tiáº¿n Ä‘á»™ tá»«ng giai Ä‘oáº¡n
  progress.forEach(p => {
    const stageLabel = `Giai Ä‘oáº¡n ${p.day_number}`;
    const icon =
      p.status === 'completed' ? 'âœ…' :
      p.status === 'in_progress' ? 'âš™ï¸' : 'â³';
    const bg =
      p.status === 'completed' ? 'bg-success-subtle' :
      p.status === 'in_progress' ? 'bg-warning-subtle' : 'bg-light';

    listDiv.innerHTML += `
      <div class="list-group-item d-flex justify-content-between align-items-center ${bg}">
        <span class="fw-bold">${icon} ${stageLabel}</span>
        <div>
          <button class="btn btn-sm btn-outline-success btn-status me-1" onclick="updateStatus(${planId}, ${p.day_number}, 'completed')">HoÃ n thÃ nh</button>
          <button class="btn btn-sm btn-outline-warning btn-status me-1" onclick="updateStatus(${planId}, ${p.day_number}, 'in_progress')">Äang há»c</button>
          <button class="btn btn-sm btn-outline-secondary btn-status" onclick="updateStatus(${planId}, ${p.day_number}, 'not_started')">ChÆ°a há»c</button>
        </div>
      </div>`;
  });
}




   // ğŸ“Š Load progress tá»« server
async function loadProgress(planId) {
  try {
    const res = await fetch(`/progress/${planId}`);
    if (!res.ok) throw new Error('Lá»—i server khi láº¥y tiáº¿n Ä‘á»™');
    const progress = await res.json();

    const modalBody = document.getElementById('planDetail');
    const btnDiv = modalBody.querySelector('#init-progress-div');
    
    if (!progress || progress.length === 0) {
      btnDiv.classList.remove('d-none');
      modalBody.querySelector('#progress-list').innerHTML =
        `<div class="alert alert-secondary text-center">ğŸ“Š ChÆ°a khá»Ÿi táº¡o tiáº¿n Ä‘á»™ cho káº¿ hoáº¡ch nÃ y.</div>`;
      modalBody.querySelector('#progress-bar').style.width = "0%";
      modalBody.querySelector('#progress-bar').innerText = "0%";
      return;
    } else {
      btnDiv.classList.add('d-none');
    }

    renderProgress(progress, planId);
  } catch (err) {
    console.error(err);
    document.getElementById('progress-list').innerHTML =
      `<div class="alert alert-danger text-center">âš ï¸ Lá»—i khi táº£i tiáº¿n Ä‘á»™ há»c!</div>`;
  }
}
async function updateStatus(planId, dayNumber, clickedStatus) {
  try {
    const modalBody = document.getElementById('planDetail');
    const listDiv = modalBody.querySelector('#progress-list');
    const bar = modalBody.querySelector('#progress-bar');

    const item = listDiv.children[dayNumber - 1];
    if (!item) return;

    const span = item.querySelector('span');
    // Láº¥y tráº¡ng thÃ¡i hiá»‡n táº¡i tá»« icon
    let currentStatus;
    if (span.innerText.startsWith('âœ…')) currentStatus = 'completed';
    else if (span.innerText.startsWith('âš™ï¸')) currentStatus = 'in_progress';
    else currentStatus = 'not_started';

    // ğŸ”„ Logic toggle
    let newStatus;
    if (clickedStatus === 'completed') {
      // náº¿u Ä‘Ã£ completed thÃ¬ toggle vá» not_started
      newStatus = currentStatus === 'completed' ? 'not_started' : 'completed';
    } else {
      // báº¥m "Äang há»c" hoáº·c "ChÆ°a há»c" â†’ Ä‘áº·t trá»±c tiáº¿p
      newStatus = clickedStatus;
    }

    // Cáº­p nháº­t UI ngay
    span.innerText =
      newStatus === 'completed' ? `âœ… Giai Ä‘oáº¡n ${dayNumber}` :
      newStatus === 'in_progress' ? `âš™ï¸ Giai Ä‘oáº¡n ${dayNumber}` :
      `â³ Giai Ä‘oáº¡n ${dayNumber}`;

    item.className = 'list-group-item d-flex justify-content-between align-items-center ' +
      (newStatus === 'completed' ? 'bg-success-subtle' :
       newStatus === 'in_progress' ? 'bg-warning-subtle' : 'bg-light');

    // Cáº­p nháº­t % chá»‰ dá»±a trÃªn completed
    const totalDays = listDiv.children.length;
    let completedDays = 0;
    Array.from(listDiv.children).forEach(li => {
      if (li.querySelector('span').innerText.startsWith('âœ…')) completedDays++;
    });
    const percent = Math.round((completedDays / totalDays) * 100);
    bar.style.width = percent + '%';
    bar.innerText = percent + '%';

    // Gá»­i lÃªn server
    const res = await fetch('/progress/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId, dayNumber, status: newStatus })
    });

    if (!res.ok) alert('âŒ Lá»—i server khi cáº­p nháº­t tiáº¿n Ä‘á»™');

  } catch (err) {
    console.error(err);
    alert('âŒ CÃ³ lá»—i khi cáº­p nháº­t tiáº¿n Ä‘á»™!');
  }
}


    // âš¡ Khá»Ÿi táº¡o tiáº¿n Ä‘á»™
async function initProgress(planId) {
  const btn = document.getElementById('init-progress-btn');
  btn.disabled = true;
  btn.innerText = "Äang khá»Ÿi táº¡o...";

  try {
    const res = await fetch('/progress/init', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId, totalDays: 10 })
    });

    const data = await res.json();
    alert(data.message || "Khá»Ÿi táº¡o thÃ nh cÃ´ng!");
    loadProgress(planId);
  } catch (err) {
    console.error(err);
    alert('âŒ Lá»—i khi khá»Ÿi táº¡o tiáº¿n Ä‘á»™!');
  } finally {
    btn.disabled = false;
    btn.innerText = "âš¡ Khá»Ÿi táº¡o tiáº¿n Ä‘á»™";
  }
}

   

    // ğŸ—‘ XÃ³a káº¿ hoáº¡ch
    async function deletePlan(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a káº¿ hoáº¡ch nÃ y khÃ´ng?')) return;
      const res = await fetch('/learning-plan/' + id, { method: 'DELETE' });
      if (res.ok) {
        alert('âœ… ÄÃ£ xÃ³a káº¿ hoáº¡ch thÃ nh cÃ´ng!');
        loadPlans();
      } else {
        alert('âŒ Lá»—i khi xÃ³a káº¿ hoáº¡ch.');
      }
    }
// ğŸ§  LÆ°u nháº­t kÃ½ há»c táº­p
async function saveJournal(planId) {
  const stage = document.getElementById('journalStage').value;
  const note = document.getElementById('journalNote').value.trim();
  if (!note) return alert('âš ï¸ Vui lÃ²ng nháº­p ná»™i dung ghi chÃº!');

  try {
    const res = await fetch('/journal/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId, stageNumber: stage, note })
    });
    const data = await res.json();
    if (res.ok) {
      alert('âœ… ÄÃ£ lÆ°u nháº­t kÃ½!');
      document.getElementById('journalNote').value = '';
      loadJournal(planId);
    } else {
      alert('âŒ ' + (data.error || 'Lá»—i khi lÆ°u nháº­t kÃ½'));
    }
  } catch (err) {
    console.error(err);
    alert('âŒ Lá»—i káº¿t ná»‘i khi lÆ°u nháº­t kÃ½!');
  }
}
let journalVisible = false;

async function toggleJournalView(planId) {
  const container = document.getElementById('journalHistory');
  if (!container) {
    console.error("âŒ KhÃ´ng tÃ¬m tháº¥y #journalHistory trong DOM!");
    return;
  }

  const isHidden = container.style.display === 'none';
  container.style.display = isHidden ? 'block' : 'none';

  if (isHidden) {
    await loadJournal(planId);
  }
}

// ğŸ“– Táº£i lá»‹ch sá»­ nháº­t kÃ½
// ğŸ“– Táº£i lá»‹ch sá»­ nháº­t kÃ½ (cÃ³ nÃºt sá»­a & xÃ³a)
async function loadJournal(planId) {
  const container = document.getElementById('journalHistory');
  if (!container) return console.error("âŒ KhÃ´ng tÃ¬m tháº¥y pháº§n hiá»ƒn thá»‹ nháº­t kÃ½!");
  
  container.innerHTML = `<div class="text-muted small text-center py-2">âŒ› Äang táº£i nháº­t kÃ½...</div>`;
  
  try {
    const res = await fetch(`/journal/${planId}`);
    const journals = await res.json();

    if (!journals || journals.length === 0) {
      container.innerHTML = `<div class="text-muted small text-center py-2">ğŸ“­ ChÆ°a cÃ³ nháº­t kÃ½ nÃ o.</div>`;
      return;
    }

    container.innerHTML = journals.map(j => `
      <div class="border-bottom py-2 d-flex justify-content-between align-items-start">
        <div>
          <div class="small text-muted">
            ğŸ—“ï¸ ${new Date(j.created_at).toLocaleString()} â€” Giai Ä‘oáº¡n ${j.stage_number}
          </div>
          <div>${j.note}</div>
        </div>
        <div class="ms-2">
          <button class="btn btn-sm btn-warning me-1" 
            onclick="editJournal(${j.id}, '${j.note.replace(/'/g, "\\'")}', ${planId})">âœï¸</button>
          <button class="btn btn-sm btn-danger" 
            onclick="deleteJournal(${j.id}, ${planId})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  } catch (err) {
    console.error('âŒ Lá»—i khi táº£i nháº­t kÃ½:', err);
    container.innerHTML = `<div class="text-danger small text-center py-2">âš ï¸ Lá»—i khi táº£i nháº­t kÃ½!</div>`;
  }
}


// chá»‰nh sá»­a nháº­t kÃ½
async function editJournal(id, oldNote, planId) {
  const newNote = prompt("âœï¸ Nháº­p ná»™i dung má»›i:", oldNote);
  if (!newNote || newNote.trim() === "") return;

  const res = await fetch(`/journal/update/${id}`, {   // âœ… ÄÃºng URL
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ note: newNote })
  });

  const data = await res.json();
  if (res.ok) {
    alert(data.message);
    loadJournal(planId);
  } else {
    alert("âŒ Lá»—i khi cáº­p nháº­t nháº­t kÃ½");
  }
}


// ğŸ—‘ï¸ XÃ³a nháº­t kÃ½
async function deleteJournal(id, planId) {
  if (!confirm("ğŸ—‘ï¸ Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a nháº­t kÃ½ nÃ y?")) return;

  const res = await fetch(`/journal/delete/${id}`, { method: "DELETE" }); // âœ… ÄÃºng URL
  const data = await res.json();
  if (res.ok) {
    alert(data.message);
    loadJournal(planId);
  } else {
    alert("âŒ Lá»—i khi xÃ³a nháº­t kÃ½");
  }
}


    // ğŸš€ Khá»Ÿi cháº¡y
    loadPlans();
  </script>
</body>
</html>
