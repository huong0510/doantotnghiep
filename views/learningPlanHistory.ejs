<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>L·ªãch s·ª≠ k·∫ø ho·∫°ch h·ªçc</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f7f9fc;
    }

    .card-day {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      padding: 15px 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .card-day:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    }

    .card-day h5 {
      color: #007bff;
      font-weight: 600;
    }

    .modal-body {
      max-height: 75vh;
      overflow-y: auto;
    }

    .progress {
      background-color: #e9ecef;
      border-radius: 10px;
    }

    .progress-bar {
      background: linear-gradient(90deg, #00bfff, #007bff);
      font-weight: 600;
    }

    .btn-status {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4">üìú L·ªãch s·ª≠ k·∫ø ho·∫°ch h·ªçc</h2>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>T√™n h·ªçc vi√™n</th>
          <th>Tr√¨nh ƒë·ªô</th>
          <th>Ng√†y t·∫°o</th>
          <th>Chi ti·∫øt</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="planList">
        <tr><td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center my-3">
      <a href="/learning-plan" class="btn btn-secondary">‚Üê Quay l·∫°i t·∫°o k·∫ø ho·∫°ch</a>

      <div class="d-flex align-items-center gap-2">
        <input type="number" id="planIdInput" class="form-control" placeholder="Nh·∫≠p ID k·∫ø ho·∫°ch..." style="width: 180px;">
        <button class="btn btn-info fw-bold shadow-sm"
          style="background: linear-gradient(90deg, #00bfff, #007bff); border: none;"
          onclick="goToAnalysis()">
          ü§ñ Ph√¢n t√≠ch nƒÉng l·ª±c (AI)
        </button>
      </div>
    </div>
  </div>

  <!-- Modal chi ti·∫øt k·∫ø ho·∫°ch -->
  <div class="modal fade" id="planModal" tabindex="-1" aria-labelledby="planModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="planModalLabel">Chi ti·∫øt k·∫ø ho·∫°ch h·ªçc</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="planDetail">ƒêang t·∫£i...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // üéØ Chuy·ªÉn ƒë·∫øn trang ph√¢n t√≠ch nƒÉng l·ª±c
    function goToAnalysis() {
      const id = document.getElementById('planIdInput').value.trim();
      if (!id) return alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ID k·∫ø ho·∫°ch tr∆∞·ªõc khi ph√¢n t√≠ch!');
      window.location.href = '/learning-plan/analysis/' + id;
    }

    // üìú Load danh s√°ch k·∫ø ho·∫°ch h·ªçc
    async function loadPlans() {
      const res = await fetch('/learning-plan/history');
      const plans = await res.json();
      const tbody = document.getElementById('planList');
      tbody.innerHTML = '';

      if (plans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o.</td></tr>';
        return;
      }

      plans.forEach(plan => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${plan.id}</td>
          <td>${plan.student_name}</td>
          <td>${plan.level}</td>
          <td>${new Date(plan.created_at).toLocaleString()}</td>
          <td><button class="btn btn-sm btn-primary" onclick="viewPlan(${plan.id})">üëÄ Xem</button></td>
          <td><button class="btn btn-sm btn-danger" onclick="deletePlan(${plan.id})">üóë X√≥a</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // üëÄ Xem chi ti·∫øt k·∫ø ho·∫°ch + ti·∫øn ƒë·ªô
    async function viewPlan(id) {
      const res = await fetch('/learning-plan/' + id);
      const plan = await res.json();
      const content = plan.plan || 'Kh√¥ng c√≥ n·ªôi dung.';

      // üü© Kh·ªëi hi·ªÉn th·ªã ti·∫øn ƒë·ªô
      const progressSection = `
        <div class="my-4">
          <h5>üìä Ti·∫øn ƒë·ªô h·ªçc</h5>
          <div class="progress mb-3">
            <div id="progress-bar" class="progress-bar bg-success" style="width: 0%">0%</div>
          </div>
          <div id="progress-list" class="list-group small mb-3"></div>
          <div id="init-progress-div" class="text-center d-none">
            <button class="btn btn-outline-primary btn-sm" id="init-progress-btn">‚ö° Kh·ªüi t·∫°o ti·∫øn ƒë·ªô</button>
          </div>
        </div>
      `;

      // Chuy·ªÉn markdown ‚Üí HTML
      const html = marked.parse(content);
      const sections = html.split(/<h3.*?>/g).filter(s => s.trim() !== '');
      let rendered = '';

      if (sections.length > 1) {
        sections.forEach((section, index) => {
          rendered += `
            <div class="card-day">
              <h5>Ng√†y ${index + 1}</h5>
              <div>${section}</div>
            </div>`;
        });
      } else {
        rendered = `<div class="card-day">${html}</div>`;
      }

      // Render to√†n b·ªô n·ªôi dung v√†o modal
      document.getElementById('planDetail').innerHTML = progressSection + rendered;

      // ‚ö° G√°n s·ª± ki·ªán kh·ªüi t·∫°o ti·∫øn ƒë·ªô
      document.getElementById('init-progress-btn').onclick = () => initProgress(id);

      const modal = new bootstrap.Modal(document.getElementById('planModal'));
      modal.show();

      // üîÑ T·∫£i ti·∫øn ƒë·ªô h·ªçc
      loadProgress(id);
    }
// üìä Render progress t·ª´ server
// üîÑ Render progress
function renderProgress(progress, planId) {
  const modalBody = document.getElementById('planDetail');
  const listDiv = modalBody.querySelector('#progress-list');
  const bar = modalBody.querySelector('#progress-bar');

  listDiv.innerHTML = '';

  const totalDays = progress.length;
  const completedDays = progress.filter(p => p.status === 'completed').length;
  const percent = Math.round((completedDays / totalDays) * 100);

  bar.style.width = percent + '%';
  bar.innerText = percent + '%';

  progress.forEach(p => {
    const stageLabel = `Giai ƒëo·∫°n ${p.day_number}`;
    const icon =
      p.status === 'completed' ? '‚úÖ' :
      p.status === 'in_progress' ? '‚öôÔ∏è' : '‚è≥';
    const bg =
      p.status === 'completed' ? 'bg-success-subtle' :
      p.status === 'in_progress' ? 'bg-warning-subtle' : 'bg-light';

    listDiv.innerHTML += `
      <div class="list-group-item d-flex justify-content-between align-items-center ${bg}">
        <span class="fw-bold">${icon} ${stageLabel}</span>
        <div>
<button class="btn btn-sm btn-outline-success btn-status me-1" onclick="updateStatus(${planId}, ${p.day_number}, 'completed')">Ho√†n th√†nh</button>
<button class="btn btn-sm btn-outline-warning btn-status me-1" onclick="updateStatus(${planId}, ${p.day_number}, 'in_progress')">ƒêang h·ªçc</button>
<button class="btn btn-sm btn-outline-secondary btn-status" onclick="updateStatus(${planId}, ${p.day_number}, 'not_started')">Ch∆∞a h·ªçc</button>

         
        </div>
      </div>`;
  });
}


   // üìä Load progress t·ª´ server
async function loadProgress(planId) {
  try {
    const res = await fetch(`/progress/${planId}`);
    if (!res.ok) throw new Error('L·ªói server khi l·∫•y ti·∫øn ƒë·ªô');
    const progress = await res.json();

    const modalBody = document.getElementById('planDetail');
    const btnDiv = modalBody.querySelector('#init-progress-div');
    
    if (!progress || progress.length === 0) {
      btnDiv.classList.remove('d-none');
      modalBody.querySelector('#progress-list').innerHTML =
        `<div class="alert alert-secondary text-center">üìä Ch∆∞a kh·ªüi t·∫°o ti·∫øn ƒë·ªô cho k·∫ø ho·∫°ch n√†y.</div>`;
      modalBody.querySelector('#progress-bar').style.width = "0%";
      modalBody.querySelector('#progress-bar').innerText = "0%";
      return;
    } else {
      btnDiv.classList.add('d-none');
    }

    renderProgress(progress, planId);
  } catch (err) {
    console.error(err);
    document.getElementById('progress-list').innerHTML =
      `<div class="alert alert-danger text-center">‚ö†Ô∏è L·ªói khi t·∫£i ti·∫øn ƒë·ªô h·ªçc!</div>`;
  }
}
async function updateStatus(planId, dayNumber, clickedStatus) {
  try {
    const modalBody = document.getElementById('planDetail');
    const listDiv = modalBody.querySelector('#progress-list');
    const bar = modalBody.querySelector('#progress-bar');

    const item = listDiv.children[dayNumber - 1];
    if (!item) return;

    const span = item.querySelector('span');
    // L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ icon
    let currentStatus;
    if (span.innerText.startsWith('‚úÖ')) currentStatus = 'completed';
    else if (span.innerText.startsWith('‚öôÔ∏è')) currentStatus = 'in_progress';
    else currentStatus = 'not_started';

    // üîÑ Logic toggle
    let newStatus;
    if (clickedStatus === 'completed') {
      // n·∫øu ƒë√£ completed th√¨ toggle v·ªÅ not_started
      newStatus = currentStatus === 'completed' ? 'not_started' : 'completed';
    } else {
      // b·∫•m "ƒêang h·ªçc" ho·∫∑c "Ch∆∞a h·ªçc" ‚Üí ƒë·∫∑t tr·ª±c ti·∫øp
      newStatus = clickedStatus;
    }

    // C·∫≠p nh·∫≠t UI ngay
    span.innerText =
      newStatus === 'completed' ? `‚úÖ Giai ƒëo·∫°n ${dayNumber}` :
      newStatus === 'in_progress' ? `‚öôÔ∏è Giai ƒëo·∫°n ${dayNumber}` :
      `‚è≥ Giai ƒëo·∫°n ${dayNumber}`;

    item.className = 'list-group-item d-flex justify-content-between align-items-center ' +
      (newStatus === 'completed' ? 'bg-success-subtle' :
       newStatus === 'in_progress' ? 'bg-warning-subtle' : 'bg-light');

    // C·∫≠p nh·∫≠t % ch·ªâ d·ª±a tr√™n completed
    const totalDays = listDiv.children.length;
    let completedDays = 0;
    Array.from(listDiv.children).forEach(li => {
      if (li.querySelector('span').innerText.startsWith('‚úÖ')) completedDays++;
    });
    const percent = Math.round((completedDays / totalDays) * 100);
    bar.style.width = percent + '%';
    bar.innerText = percent + '%';

    // G·ª≠i l√™n server
    const res = await fetch('/progress/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId, dayNumber, status: newStatus })
    });

    if (!res.ok) alert('‚ùå L·ªói server khi c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô');

  } catch (err) {
    console.error(err);
    alert('‚ùå C√≥ l·ªói khi c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô!');
  }
}


    // ‚ö° Kh·ªüi t·∫°o ti·∫øn ƒë·ªô
async function initProgress(planId) {
  const btn = document.getElementById('init-progress-btn');
  btn.disabled = true;
  btn.innerText = "ƒêang kh·ªüi t·∫°o...";

  try {
    const res = await fetch('/progress/init', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId, totalDays: 10 })
    });

    const data = await res.json();
    alert(data.message || "Kh·ªüi t·∫°o th√†nh c√¥ng!");
    loadProgress(planId);
  } catch (err) {
    console.error(err);
    alert('‚ùå L·ªói khi kh·ªüi t·∫°o ti·∫øn ƒë·ªô!');
  } finally {
    btn.disabled = false;
    btn.innerText = "‚ö° Kh·ªüi t·∫°o ti·∫øn ƒë·ªô";
  }
}

   

    // üóë X√≥a k·∫ø ho·∫°ch
    async function deletePlan(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k·∫ø ho·∫°ch n√†y kh√¥ng?')) return;
      const res = await fetch('/learning-plan/' + id, { method: 'DELETE' });
      if (res.ok) {
        alert('‚úÖ ƒê√£ x√≥a k·∫ø ho·∫°ch th√†nh c√¥ng!');
        loadPlans();
      } else {
        alert('‚ùå L·ªói khi x√≥a k·∫ø ho·∫°ch.');
      }
    }

    // üöÄ Kh·ªüi ch·∫°y
    loadPlans();
  </script>
</body>
</html>
