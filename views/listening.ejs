<h1><%= title %></h1>

<!-- Form ch·ªçn b√†i -->
<form method="get" action="">
  <div class="custom-select-wrapper">
    <select name="lesson" id="lesson" class="custom-select" onchange="this.form.submit()">
      <% for (let i = 1; i <= totalLessons; i++) { %>
        <option value="<%= i %>" <%= i == currentLesson ? 'selected' : '' %>>
          B√†i <%= i %>
        </option>
      <% } %>
    </select>
  </div>
</form>

<!-- Audio -->
<audio controls style="margin-top:10px;">
  <source src="<%= lessons[0].audio %>" type="audio/mpeg">
  Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
</audio>

<!-- Nh·∫≠p transcript -->
<textarea id="userAnswer" class="form-control" placeholder="Nh·∫≠p transcript..." rows="8" style="width: 100%;"></textarea>

<!-- Progress (feedback %) -->
<div class="progress" style="height: 30px; margin-top: 20px;">
  <div id="progress" class="progress-bar" style="width:0%">0%</div>
</div>

<div id="feedback" style="margin-top: 15px; font-weight: bold; color: #444;"></div>

<button id="submitBtn" class="btn btn-primary mt-2">N·ªôp b√†i</button>

<!-- Highlight ƒë√°p √°n -->
<div id="result" style="margin-top: 20px; font-size: 18px;"></div>

<!-- Feedback AI -->
<div id="aiResult" class="mt-3"></div>

<!-- Progress Bar ƒëi·ªÉm -->
<div class="progress mt-3" style="height: 25px; display:none;" id="scoreBarWrapper">
  <div id="scoreBar" class="progress-bar" 
       role="progressbar" style="width: 0%;" 
       aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    0%
  </div>
</div>

<!-- Box k·∫øt qu·∫£ -->
<div id="result-box" class="card mt-4" style="display:none;">
  <div class="card-body">
    <h5 class="card-title">K·∫øt qu·∫£</h5>
    <div class="mb-3">
      <label><strong>ƒêi·ªÉm:</strong></label>
      <div class="progress" style="height: 25px;">
        <div id="score-bar" class="progress-bar bg-success" role="progressbar" 
             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          0/100
        </div>
      </div>
    </div>
    <p><strong>Feedback:</strong> <span id="feedback-text"></span></p>
    <p><strong>Highlight:</strong> <span id="highlight-text"></span></p>
  </div>
</div>

<script>
  const correctAnswer = `<%= lessons[0].answer %>`; // transcript chu·∫©n

  // üîß Chu·∫©n h√≥a chu·ªói tr∆∞·ªõc khi so s√°nh
function normalizeText(text) {
  return text
    .replace(/\s+/g, '')       // b·ªè kho·∫£ng tr·∫Øng, xu·ªëng d√≤ng
    .replace(/[„ÄÇ„ÄÅÔºé]/g, '„ÄÇ') // chu·∫©n h√≥a d·∫•u c√¢u ti·∫øng Nh·∫≠t
    .trim();
}

  // Highlight t·ª´ sai
 function highlightMistakes(userText, correctText) {
  userText = normalizeText(userText);
  correctText = normalizeText(correctText);

  let result = "";
  const maxLen = Math.max(userText.length, correctText.length);

  for (let i = 0; i < maxLen; i++) {
    if (userText[i] === correctText[i]) {
      result += correctText[i] || "";
    } else {
      if (correctText[i]) {
        result += `<span style="color:red">${correctText[i]}</span>`;
      }
    }
  }
  return result;
}


  // Render ƒë√°p √°n chu·∫©n + highlight l·ªói
  function renderAnswer(userText) {
    const resultDiv = document.getElementById("result");
    const sentences = correctAnswer.split("„ÄÇ");
    let output = "";

    sentences.forEach((sentence) => {
      if (sentence.trim()) {
        let highlighted = highlightMistakes(userText, sentence.trim());
        output += `
          <p style="color: black; font-size:16px;">
            <button onclick="speakSentence('${sentence.trim()}')" 
                    style="border:none; background:none; cursor:pointer; font-size:18px;">üîä</button>
            ${highlighted}„ÄÇ
          </p>
        `;
      }
    });

    resultDiv.innerHTML = `
      <p><strong>ƒê√°p √°n & highlight l·ªói:</strong></p>
      <div class="answer">${output}</div>
    `;
  }

  // Text-to-Speech ti·∫øng Nh·∫≠t
  function speakSentence(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "ja-JP";
    speechSynthesis.speak(utterance);
  }

  // ‚úÖ H√†m submit c≈© (gi·ªØ nguy√™n, d√πng cho /listening/feedback)
  async function submitAnswerOld() {
    const userAnswer = document.querySelector("#userAnswer").value;
    const correctAnswer = "<%= lessons[0].text %>"; // l·∫•y t·ª´ server render

    const res = await fetch("/listening/feedback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userAnswer, correctAnswer }),
    });

    const data = await res.json();
// N·∫øu server tr·∫£ JSON th√¥, chuy·ªÉn n√≥ v·ªÅ ƒë·ªëi t∆∞·ª£ng
if (typeof data === "string") {
  try {
    const parsed = JSON.parse(data);
    data = parsed;
  } catch {
    console.warn("‚ö†Ô∏è Kh√¥ng parse ƒë∆∞·ª£c JSON:", data);
  }
}

    if (data.success) {
      const match = data.feedback.match(/(\d{1,3})\/?100?/);
      let score = match ? parseInt(match[1]) : 0;

      document.querySelector("#feedback").innerText = data.feedback;
      document.querySelector("#progress").style.width = score + "%";
      document.querySelector("#progress").innerText = score + "%";
    }
  }
// ‚úÖ H√†m submit m·ªõi (ch·∫•m ƒëi·ªÉm AI + highlight)
async function submitAnswerNew() {
  const userAnswerRaw = document.getElementById("userAnswer").value.trim();
  renderAnswer(userAnswerRaw); // render highlight so s√°nh v·ªõi ƒë√°p √°n

  // üß† Kh√¥ng chu·∫©n h√≥a khi g·ª≠i l√™n AI ‚Äî gi·ªØ nguy√™n b·∫£n g·ªëc
  const res = await fetch("/api/evaluate-answer", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userAnswer: userAnswerRaw,
      correctAnswer: correctAnswer
    })
  });

  let data;
  try {
    data = await res.json();
  } catch (err) {
    console.error("‚ùå JSON parse l·ªói:", err);
    document.getElementById("aiResult").innerHTML =
      `<div class="alert alert-danger">L·ªói ƒë·ªçc ph·∫£n h·ªìi t·ª´ server.</div>`;
    return;
  }

  // üß© Ki·ªÉm tra n·∫øu AI tr·∫£ JSON th√¥ (b·ªã l·ªói)
  if (!data.success || typeof data.score !== "number") {
    document.getElementById("aiResult").innerHTML =
      `<div class="alert alert-warning">‚ö†Ô∏è AI ch∆∞a ch·∫•m ƒë∆∞·ª£c. Th·ª≠ l·∫°i sau.</div>`;
    console.warn("D·ªØ li·ªáu AI tr·∫£ v·ªÅ:", data);
    return;
  }

/// ‚úÖ N·∫øu th√†nh c√¥ng ‚Üí hi·ªÉn th·ªã k·∫øt qu·∫£
if (data.success) {
  document.getElementById("result-box").style.display = "block";

  const scoreBar = document.getElementById("score-bar");
  scoreBar.style.width = data.score + "%";
  scoreBar.innerText = data.score + "/100";
  scoreBar.setAttribute("aria-valuenow", data.score);

  const fbEl = document.getElementById("feedback-text");
  const hlEl = document.getElementById("highlight-text");

  // Helper: escape HTML
  function escapeHtml(str) {
    if (!str) return "";
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // --- H√†m xo√° ch·ªØ "Feedback:" ch·ªâ khi ƒë·ª©ng tr∆∞·ªõc "ƒêi·ªÉm:" ---
  function cleanLabel(str) {
    if (!str) return "";
    return str
      .replace(/Feedback:\s*(?=ƒêi·ªÉm:)/gi, "") // ch·ªâ xo√° n·∫øu ƒë·ª©ng tr∆∞·ªõc ƒêi·ªÉm:
      .replace(/^\s*Feedback:\s*/i, "")        // xo√° lu√¥n n·∫øu ƒë·ª©ng ƒë·∫ßu chu·ªói
      .replace(/\n{2,}/g, "\n")
      .trim();
  }

  try {
    let fb = data.feedback || "";
    let hl = data.highlight || "";

    // N·∫øu feedback l√† JSON string (AI tr·∫£ v·ªÅ d·∫°ng chu·ªói JSON)
    if (typeof fb === "string" && fb.includes("{")) {
      try {
        const parsed = JSON.parse(fb.match(/\{[\s\S]*\}/)[0]);
        fb = parsed.feedback || "";
        hl = parsed.highlight || "";
        if (parsed.score) data.score = parsed.score;
      } catch (e) {
        console.warn("Kh√¥ng parse ƒë∆∞·ª£c JSON trong feedback:", e);
      }
    }

    // üßπ L√†m s·∫°ch nh√£n tr∆∞·ªõc khi hi·ªÉn th·ªã
    fb = cleanLabel(fb);
    hl = cleanLabel(hl);

    // --- G√°n n·ªôi dung sau khi x·ª≠ l√Ω ---
    fbEl.innerHTML = `<strong>ƒêi·ªÉm:</strong> ${data.score}/100<br>${escapeHtml(fb)}`;
    if (/<[^>]+>/.test(hl)) {
      hlEl.innerHTML = hl;
    } else {
      hlEl.innerText = hl || "Kh√¥ng c√≥ l·ªói";
    }

  } catch (err) {
    console.error("‚ùå L·ªói hi·ªÉn th·ªã feedback:", err);
    fbEl.innerText = data.feedback ?? "Kh√¥ng th·ªÉ hi·ªÉn th·ªã feedback.";
    hlEl.innerText = data.highlight ?? "Kh√¥ng c√≥ l·ªói";
  }

  // Progress bar nh·ªè ph√≠a tr√™n
  const scoreBarWrapper = document.getElementById("scoreBarWrapper");
  scoreBarWrapper.style.display = "block";
  const scoreBar2 = document.getElementById("scoreBar");
  scoreBar2.style.width = data.score + "%";
  scoreBar2.innerText = data.score + "%";
} else {
  document.getElementById("aiResult").innerHTML =
    `<div class="alert alert-danger">‚ùå L·ªói AI: ${data.error || 'Kh√¥ng ch·∫•m ƒë∆∞·ª£c'}</div>`;
}

}

  // Khi b·∫•m n√∫t N·ªôp b√†i ‚Üí g·ªçi API m·ªõi
  document.getElementById("submitBtn").addEventListener("click", (e) => {
    e.preventDefault();
    submitAnswerNew();
  });
</script>
