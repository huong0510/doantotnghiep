

<div class="page-listening">  <!-- ‚úÖ Th√™m d√≤ng n√†y -->
  <h1><%= title %></h1>

  <div class="listening-page">
    <!-- Form ch·ªçn b√†i -->
    <form method="get" action="">
      <div class="custom-select-wrapper">
        <select name="lesson" id="lesson" class="custom-select" onchange="this.form.submit()">
          <% for (let i = 1; i <= totalLessons; i++) { %>
            <option value="<%= i %>" <%= i == currentLesson ? 'selected' : '' %>>
              B√†i <%= i %>
            </option>
          <% } %>
        </select>
      </div>
    </form>
  </div>

 
</div>



<!-- HTML: wrap audio trong 1 div -->
<div class="audio-wrap">
  <audio controls preload="metadata">
    <source src="<%= lessons[0].audio %>" type="audio/mpeg">
    Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
  </audio>
</div>

<!-- Nh·∫≠p transcript -->
<textarea id="userAnswer" class="form-control" placeholder="Nh·∫≠p transcript..." rows="8" style="width: 100%;"></textarea>

<div class="page-listening">
  <!-- Progress (feedback %) -->
  <div class="progress" style="height: 30px; margin-top: 20px;">
    <div id="progress" class="progress-bar" style="width:0%">0%</div>
  </div>

 

  <button id="submitBtn" class="submit-btn mt-2">N·ªôp b√†i</button>
  <audio id="submitSound" src="/sounds/bubble-pop-389501.mp3"></audio>

</div>


<!-- Highlight ƒë√°p √°n -->
<div id="result" style="margin-top: 20px; font-size: 18px;"></div>

<!-- Feedback AI -->
<div id="aiResult" class="mt-3"></div>

<!-- Progress Bar ƒëi·ªÉm -->
<div class="progress mt-3" style="height: 25px; display:none;" id="scoreBarWrapper">
  <div id="scoreBar" class="progress-bar" 
       role="progressbar" style="width: 0%;" 
       aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    0%
  </div>
</div>

<!-- Box k·∫øt qu·∫£ -->
<div id="result-box" class="card mt-4 shadow-sm" style="display:none; border-radius:12px;">
  <div class="card-body">
    <h4 class="card-title text-center text-primary fw-bold mb-3">
      üéß K·∫øt qu·∫£ ph√¢n t√≠ch ph·∫ßn nghe
    </h4>

    <div class="mb-3">
      <label><strong>ƒêi·ªÉm t·ªïng:</strong></label>
      <div class="progress" style="height: 25px; border-radius:10px; overflow:hidden;">
        <div id="score-bar" class="progress-bar bg-success fw-bold" 
             role="progressbar" style="width: 0%;" 
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          0/100
        </div>
      </div>
    </div>

    <p><strong>Feedback:</strong></p>
    <div id="feedback-text" class="p-3 bg-light rounded border"></div>

    <p class="mt-3"><strong>Highlight l·ªói:</strong></p>
    <div id="highlight-text" class="p-3 bg-white rounded border" style="white-space: pre-line;"></div>

    <!-- üßæ Ph√¢n t√≠ch chi ti·∫øt l·ªói -->
    <div id="errorDetails" class="mt-4" style="display:none;">
      <h5 class="fw-bold text-primary mb-3">üìã Ph√¢n t√≠ch chi ti·∫øt l·ªói</h5>

      <div class="d-flex justify-content-between mb-2">
        <p><b>T·ªïng s·ªë l·ªói:</b> <span id="errorCount" class="text-danger">0</span></p>
        <p><b>T·ªâ l·ªá ƒë√∫ng:</b> <span id="accuracyRate" class="text-success">0%</span></p>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle shadow-sm">
          <thead class="table-primary text-center">
            <tr>
              <th>STT</th>
              <th>C√¢u g·ªëc</th>
              <th>C√¢u b·∫°n n√≥i</th>
              <th>Lo·∫°i l·ªói</th>
              <th>G·ª£i √Ω s·ª≠a</th>
            </tr>
          </thead>
          <tbody id="errorTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script>
  const correctAnswer = `<%= lessons[0].answer %>`; // transcript chu·∫©n

  // üîß Chu·∫©n h√≥a chu·ªói tr∆∞·ªõc khi so s√°nh
function normalizeText(text) {
  return text
    .replace(/\s+/g, '')       // b·ªè kho·∫£ng tr·∫Øng, xu·ªëng d√≤ng
    .replace(/[„ÄÇ„ÄÅÔºé]/g, '„ÄÇ') // chu·∫©n h√≥a d·∫•u c√¢u ti·∫øng Nh·∫≠t
    .trim();
}

// üîπ Highlight th√¥ng minh ‚Äî so s√°nh theo t·ª´ / c·ª•m kana
function highlightMistakes(userText, correctText) {
  // C·∫Øt t·ª´ ho·∫∑c c·ª•m b·∫±ng d·∫•u c√¢u / kho·∫£ng tr·∫Øng
  const userWords = userText.split(/[\s„ÄÇ„ÄÅÔºÅ!Ôºü?„Éª]/).filter(Boolean);
  const correctWords = correctText.split(/[\s„ÄÇ„ÄÅÔºÅ!Ôºü?„Éª]/).filter(Boolean);

  let result = "";
  let userIdx = 0;

  for (let i = 0; i < correctWords.length; i++) {
    const word = correctWords[i];
    const match = userWords[userIdx];

    if (match === word) {
      result += `<span style="color:black;">${word}</span> `;
      userIdx++;
    } else {
      result += `<span style="color:red; background:#ffe5e5; border-radius:6px; padding:2px 4px;">${word}</span> `;
    }
  }

  return result.trim();
}



  // Render ƒë√°p √°n chu·∫©n + highlight l·ªói
  function renderAnswer(userText) {
    const resultDiv = document.getElementById("result");
    const sentences = correctAnswer.split("„ÄÇ");
    let output = "";

    sentences.forEach((sentence) => {
      if (sentence.trim()) {
        let highlighted = highlightMistakes(userText, sentence.trim());
        output += `
          <p style="color: black; font-size:16px;">
            <button onclick="speakSentence('${sentence.trim()}')" 
                    style="border:none; background:none; cursor:pointer; font-size:18px;">üîä</button>
            ${highlighted}„ÄÇ
          </p>
        `;
      }
    });

    resultDiv.innerHTML = `
      <p><strong>ƒê√°p √°n & highlight l·ªói:</strong></p>
      <div class="answer">${output}</div>
    `;
  }

  // Text-to-Speech ti·∫øng Nh·∫≠t
  function speakSentence(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "ja-JP";
    speechSynthesis.speak(utterance);
  }

  // ‚úÖ H√†m submit c≈© (gi·ªØ nguy√™n, d√πng cho /listening/feedback)
 async function submitAnswerOld() {
  const resultDiv = document.getElementById("errorDetails");
  resultDiv.innerHTML = "<p class='text-muted'>‚è≥ ƒêang ch·∫•m ƒëi·ªÉm...</p>";
  document.getElementById("score").innerText = "-";
  document.getElementById("feedback").innerText = "-";
  document.getElementById("highlight").innerText = "-";
  
  const userAnswer = document.querySelector("#userAnswer").value;
  const correctAnswer = document.getElementById("correctAnswer").value;


    const res = await fetch("/listening/feedback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userAnswer, correctAnswer }),
    });

    const data = await res.json();
// N·∫øu server tr·∫£ JSON th√¥, chuy·ªÉn n√≥ v·ªÅ ƒë·ªëi t∆∞·ª£ng
if (typeof data === "string") {
  try {
    const parsed = JSON.parse(data);
    data = parsed;
  } catch {
    console.warn("‚ö†Ô∏è Kh√¥ng parse ƒë∆∞·ª£c JSON:", data);
  }
}

    if (data.success) {
  document.getElementById("score").innerText = data.score + "%";
  document.getElementById("feedback").innerText = data.feedback;
  document.getElementById("highlight").innerText = data.highlight;

  const detailDiv = document.getElementById("errorDetails");
  detailDiv.innerHTML = ""; // x√≥a c≈©

  if (data.errors && data.errors.length > 0) {
    let table = `
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>Ph·∫ßn g·ªëc</th>
            <th>Ph·∫ßn h·ªçc vi√™n</th>
            <th>Lo·∫°i l·ªói</th>
            <th>G·ª£i √Ω</th>
          </tr>
        </thead>
        <tbody>
    `;
    data.errors.forEach(err => {
      table += `
        <tr>
          <td>${err.original || ""}</td>
          <td>${err.user || ""}</td>
          <td><span class="badge bg-${err.typeColor || "secondary"}">${err.type || ""}</span></td>
          <td>${err.suggestion || ""}</td>
        </tr>
      `;
    });
    table += "</tbody></table>";
    detailDiv.innerHTML = table;
  } else {
    detailDiv.innerHTML = "<p class='text-muted'>Kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ph√°t hi·ªán.</p>";
  }
}
  }
// ‚úÖ H√†m submit m·ªõi (ch·∫•m ƒëi·ªÉm AI + highlight)
async function submitAnswerNew() {
  const userAnswerRaw = document.getElementById("userAnswer").value.trim();
  renderAnswer(userAnswerRaw); // render highlight so s√°nh v·ªõi ƒë√°p √°n

  // üß† Kh√¥ng chu·∫©n h√≥a khi g·ª≠i l√™n AI ‚Äî gi·ªØ nguy√™n b·∫£n g·ªëc
  const res = await fetch("/listening/feedback", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    userAnswer: userAnswerRaw,
    correctAnswer: correctAnswer
  })
});


  let data;
  try {
    data = await res.json();
  } catch (err) {
    console.error("‚ùå JSON parse l·ªói:", err);
    document.getElementById("aiResult").innerHTML =
      `<div class="alert alert-danger">L·ªói ƒë·ªçc ph·∫£n h·ªìi t·ª´ server.</div>`;
    return;
  }
  // ‚úÖ Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ
console.log("‚úÖ K·∫øt qu·∫£ t·ª´ AI:", data);
// ‚úÖ N·∫øu AI kh√¥ng c√≥ m·∫£ng errors, t·ª± t·∫°o
if (!data.errors || !Array.isArray(data.errors)) {
  data.errors = [];

  const matches = (data.highlight || "").match(/\[\*(.*?)\*\]/g);
  if (matches && matches.length > 0) {
    matches.forEach((m) => {
      const wrong = m.replace(/\[\*|\*\]/g, "");
      data.errors.push({
        original: correctAnswer,
        user: wrong,
        type: "Ng·ªØ ph√°p",
        suggestion: `Ph·∫ßn "${wrong}" c√≥ th·ªÉ sai ng·ªØ ph√°p.`,
      });
    });
  } 
}
  // ‚ùå ƒê·ª´ng lu√¥n push l·ªói m·∫∑c ƒë·ªãnh
  // ‚úÖ Ch·ªâ th√™m n·∫øu ƒëi·ªÉm < 80 (t·ª©c AI ch·∫•m k√©m)
  

  // üß© Ki·ªÉm tra n·∫øu AI tr·∫£ JSON th√¥ (b·ªã l·ªói)
// üß© N·∫øu AI tr·∫£ chu·ªói JSON th√¥ (v√≠ d·ª• nh∆∞ "{...}" ho·∫∑c c√≥ text k√®m JSON)
if (!data.success || typeof data.score !== "number") {
  // N·∫øu data l√† chu·ªói, th·ª≠ t√°ch JSON trong ƒë√≥
  if (typeof data === "string") {
    const jsonMatch = data.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        data = parsed;
        data.success = true;
      } catch (err) {
        console.warn("‚ö†Ô∏è Kh√¥ng parse ƒë∆∞·ª£c JSON:", err);
      }
    }
  }
}


/// ‚úÖ N·∫øu th√†nh c√¥ng ‚Üí hi·ªÉn th·ªã k·∫øt qu·∫£
if (data.success) {
  document.getElementById("result-box").style.display = "block";

  const scoreBar = document.getElementById("score-bar");
  scoreBar.style.width = data.score + "%";
  scoreBar.innerText = data.score + "/100";
  scoreBar.setAttribute("aria-valuenow", data.score);

  const fbEl = document.getElementById("feedback-text");
  const hlEl = document.getElementById("highlight-text");
  // Feedback & highlight
fbEl.innerText = data.feedback || "Kh√¥ng c√≥ nh·∫≠n x√©t.";
hlEl.innerHTML = (data.highlight || "Kh√¥ng c√≥ l·ªói.")
  .replaceAll("[*", '<mark class="bg-danger text-white rounded px-1">')
  .replaceAll("*]", '</mark>');

// üß† N·∫øu AI tr·∫£ k√®m danh s√°ch l·ªói chi ti·∫øt
if (data.errors && Array.isArray(data.errors) && data.errors.length > 0) {
  const tbody = document.getElementById("errorTableBody");
  tbody.innerHTML = data.errors.map((err, i) => `
    <tr>
      <td class="text-center">${i + 1}</td>
      <td>${err.original || ""}</td>
      <td>${err.user || ""}</td>
      <td class="text-center">
        <span class="badge bg-${err.typeColor || 'danger'}">${err.type || 'L·ªói'}</span>
      </td>
      <td>${err.suggestion || "‚Äî"}</td>
    </tr>
  `).join("");

  document.getElementById("errorCount").innerText = data.errors.length;
  const accuracy = Math.max(0, 100 - data.errors.length * 5); // v√≠ d·ª•: m·ªói l·ªói tr·ª´ 5%
  document.getElementById("accuracyRate").innerText = `${accuracy}%`;
  document.getElementById("errorDetails").style.display = "block";
} else {
  document.getElementById("errorDetails").style.display = "none";
}

  // Helper: escape HTML
  function escapeHtml(str) {
    if (!str) return "";
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // --- H√†m xo√° ch·ªØ "Feedback:" ch·ªâ khi ƒë·ª©ng tr∆∞·ªõc "ƒêi·ªÉm:" ---
  function cleanLabel(str) {
    if (!str) return "";
    return str
      .replace(/Feedback:\s*(?=ƒêi·ªÉm:)/gi, "") // ch·ªâ xo√° n·∫øu ƒë·ª©ng tr∆∞·ªõc ƒêi·ªÉm:
      .replace(/^\s*Feedback:\s*/i, "")        // xo√° lu√¥n n·∫øu ƒë·ª©ng ƒë·∫ßu chu·ªói
      .replace(/\n{2,}/g, "\n")
      .trim();
  }

  try {
    let fb = data.feedback || "";
    let hl = data.highlight || "";

    // N·∫øu feedback l√† JSON string (AI tr·∫£ v·ªÅ d·∫°ng chu·ªói JSON)
    if (typeof fb === "string" && fb.includes("{")) {
      try {
        const parsed = JSON.parse(fb.match(/\{[\s\S]*\}/)[0]);
        fb = parsed.feedback || "";
        hl = parsed.highlight || "";
        if (parsed.score) data.score = parsed.score;
      } catch (e) {
        console.warn("Kh√¥ng parse ƒë∆∞·ª£c JSON trong feedback:", e);
      }
    }

    // üßπ L√†m s·∫°ch nh√£n tr∆∞·ªõc khi hi·ªÉn th·ªã
    fb = cleanLabel(fb);
    hl = cleanLabel(hl);

    // --- G√°n n·ªôi dung sau khi x·ª≠ l√Ω ---
    fbEl.innerHTML = `
  <p style="margin:0"><strong>ƒêi·ªÉm:</strong> ${data.score}/100</p>
  <p style="white-space:pre-line; margin-top:5px;">${escapeHtml(fb)}</p>
`;
    if (/<[^>]+>/.test(hl)) {
      hlEl.innerHTML = hl;
    } else {
      hlEl.innerText = hl || "Kh√¥ng c√≥ l·ªói";
    }

  } catch (err) {
    console.error("‚ùå L·ªói hi·ªÉn th·ªã feedback:", err);
    fbEl.innerText = data.feedback ?? "Kh√¥ng th·ªÉ hi·ªÉn th·ªã feedback.";
    hlEl.innerText = data.highlight ?? "Kh√¥ng c√≥ l·ªói";
  }

  // Progress bar nh·ªè ph√≠a tr√™n
  
}

}

  // Khi b·∫•m n√∫t N·ªôp b√†i ‚Üí g·ªçi API m·ªõi
  document.getElementById("submitBtn").addEventListener("click", (e) => {
    e.preventDefault();
    submitAnswerNew();
  });
 document.addEventListener("DOMContentLoaded", function () {
    const submitBtn = document.getElementById("submitBtn");
    const submitSound = document.getElementById("submitSound");

    if (submitBtn) {
      submitBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        // üîä Ph√°t √¢m thanh "n·ªôp b√†i"
        if (submitSound) {
          submitSound.currentTime = 0;
          try {
            await submitSound.play();
          } catch (err) {
            console.warn("Kh√¥ng th·ªÉ ph√°t √¢m thanh:", err);
          }
        }

        // üß† G·ªçi h√†m ch·∫•m ƒëi·ªÉm AI
        submitAnswerNew();
      });
    }
  });

</script>
